# IntelliJ AI Javadoc 插件操作手册

## 📋 目录

1. [插件功能概览](#插件功能概览)
2. [用户入口和触发方式](#用户入口和触发方式)
3. [操作步骤和效果](#操作步骤和效果)
4. [设置页面配置详解](#设置页面配置详解)
5. [开发者指南](#开发者指南)
6. [常见问题解答](#常见问题解答)

---

## 🚀 插件功能概览

### 核心功能

IntelliJ AI Javadoc 插件是一个功能强大的工具，利用人工智能为您的 Java 代码自动生成高质量的 JavaDoc 注释。插件支持多种 AI
服务提供商，提供智能且上下文感知的文档建议。

#### 主要特性

- **🤖 多 AI 提供商支持**：支持通义千问（阿里云）、Ollama 本地模型、自定义 OpenAI 兼容服务
- **🎯 智能元素识别**：根据光标位置智能识别要生成文档的元素（方法、字段、类）
- **📝 自动生成 JavaDoc**：为类、方法、字段生成符合规范的 JavaDoc 注释
- **🔄 多种触发方式**：支持快捷键、右键菜单、Generate 菜单和 Intention Action
- **📦 批量处理**：支持为整个文件或选中的多个文件批量生成文档
- **⚡ 增量更新**：只为没有 JavaDoc 注释的类和方法生成文档，不会覆盖已有的注释
- **🧪 测试方法识别**：自动识别 JUnit 4 和 JUnit 5 的测试方法，使用专门的模板生成文档
- **✅ 配置验证**：内置连接测试功能，确保配置正确
- **🎨 智能注释替换**：重新生成时自动替换旧注释，保持代码整洁
- **📏 字段格式化**：智能选择单行或多行格式，简单字段使用单行注释

#### 技术特点

- **异步处理**：后台生成文档，不阻塞 IDE UI
- **进度显示**：实时显示处理进度和统计信息
- **错误隔离**：单个任务失败不影响其他任务
- **自动格式化**：生成的 JavaDoc 自动格式化
- **智能定位**：根据光标位置自动识别处理范围

---

## 🎯 用户入口和触发方式

插件提供了 5 种不同的触发方式，满足不同用户的使用习惯：

### 1. 快捷键方式（推荐）

**快捷键**：

- **Windows/Linux**：`Ctrl + Shift + D`
- **macOS**：`Cmd + Shift + D`

**特点**：

- 最快捷的触发方式
- 智能定位：根据光标位置自动识别要生成文档的元素
- 支持所有代码元素（类、方法、字段）

**智能定位逻辑**：

- 光标在方法上 → 只为该方法生成文档
- 光标在字段上 → 只为该字段生成文档
- 光标在类声明上 → 只为该类生成文档
- 光标在类内部（但不在特定成员上）→ 为整个类及所有成员生成文档
- 其他情况 → 为整个文件生成文档

### 2. 编辑器右键菜单

**位置**：在编辑器中右键 → "Generate JavaDoc with AI"

**特点**：

- 与快捷键功能相同
- 适合不习惯使用快捷键的用户
- 智能定位功能完全一致

### 3. Generate 菜单

**快捷键**：

- **Windows/Linux**：`Alt + Insert`
- **macOS**：`Cmd + N`

**菜单位置**：Generate 菜单 → "JavaDoc with AI"

**特点**：

- 集成到 IntelliJ 的 Generate 菜单
- 与其他代码生成功能统一入口
- 智能定位功能完全一致

### 4. Intention Action（快速修复）

**快捷键**：

- **Windows/Linux**：`Alt + Enter`
- **macOS**：`Option + Enter`

**特点**：

- 只在可以生成 JavaDoc 的元素上显示
- 自动过滤已有 JavaDoc 的元素
- 更精确的上下文感知
- 不在文件级别显示（避免重复）

**显示条件**：

1. 光标在类、方法或字段上
2. 该元素还没有 JavaDoc 注释
3. 当前文件是 Java 文件

### 5. 文件/目录右键菜单

**位置**：项目视图中，右键文件/目录 → "Generate JavaDoc with AI"

**特点**：

- 支持批量处理多个文件或整个目录
- 不适用智能定位（批量处理）
- 适合大规模文档生成

---

## 📝 操作步骤和效果

### 基本操作流程

#### 1. 首次使用配置

**步骤**：

1. 打开 IntelliJ IDEA
2. 进入 **Settings**（macOS 上为 Preferences）→ **Tools** → **AI Javadoc**
3. 选择 AI 提供商（推荐通义千问）
4. 配置 API Key 和模型
5. 点击 **Test Connection** 验证配置
6. 点击 **Apply** 保存配置

#### 2. 生成单个元素文档

**步骤**：

1. 将光标放在要生成文档的元素上（方法、字段、类）
2. 使用任意触发方式（推荐快捷键 `Cmd+Shift+D`）
3. 等待处理完成
4. 查看生成的 JavaDoc 注释

**效果示例**：

**Before**：

```java
public class UserService {
    private String username;
    
    public String getUsername() {
        return username;
    }
}
```

**After**：

```java
/**
 * 用户服务类
 * 
 * <p>提供用户相关的业务逻辑处理
 */
public class UserService {
    /** 用户名 */
    private String username;
    
    /**
     * 获取用户名
     * 
     * @return 用户名
     */
    public String getUsername() {
        return username;
    }
}
```

#### 3. 批量生成文档

**步骤**：

1. 在项目视图中右键点击文件或目录
2. 选择 "Generate JavaDoc with AI"
3. 等待处理完成
4. 查看进度和统计信息

**效果**：

- 显示处理进度：`正在处理: 5/10`
- 显示完成统计：`成功: 8, 失败: 1, 跳过: 1`

### 智能定位示例

#### 示例 1：为单个方法生成

```java
public class Calculator {
    
    public int add(int a, int b) {  // 光标在这一行
        return a + b;
    }
    
    public int subtract(int a, int b) {
        return a - b;
    }
}
```

**操作**：将光标放在 `add` 方法上，按 `Cmd+Shift+D`

**结果**：只为 `add` 方法生成 JavaDoc，`subtract` 方法不受影响

#### 示例 2：为单个字段生成

```java
public class User {
    
    private String name;  // 光标在这一行
    
    private int age;
    
    public String getName() {
        return name;
    }
}
```

**操作**：将光标放在 `name` 字段上，按 `Cmd+Shift+D`

**结果**：只为 `name` 字段生成 JavaDoc

#### 示例 3：为整个类生成

```java
public class Product {  // 光标在类名上
    
    private String name;
    
    private double price;
    
    public String getName() {
        return name;
    }
}
```

**操作**：将光标放在类名 `Product` 上，按 `Cmd+Shift+D`

**结果**：为类、所有字段和所有方法生成 JavaDoc

### 测试方法识别

插件能够自动识别 JUnit 4 和 JUnit 5 的测试方法，并使用专门的模板生成更符合测试方法特点的文档。

**示例**：

**Before**：

```java
@Test
public void testCalculateSum() {
    // 测试代码
}
```

**After**：

```java
/**
 * 测试计算总和功能
 * 
 * <p>验证 add 方法能正确计算两个数的和
 * 
 * <p>测试场景：
 * <ul>
 *   <li>正常情况：正数相加</li>
 *   <li>边界情况：零值相加</li>
 *   <li>异常情况：负数相加</li>
 * </ul>
 */
@Test
public void testCalculateSum() {
    // 测试代码
}
```

### 字段格式化

插件会根据字段的复杂度智能选择注释格式：

**简单字段**（单行格式）：

```java
/** 用户名 */
private String username;

/** 登陆时的验证码，比如：手机上收到的那个码 */
private String code;
```

**复杂字段**（多行格式）：

```java
/**
 * 用户配置信息
 * 
 * <p>包含用户偏好设置、主题配置等
 * 
 * @see UserConfig
 */
private UserConfig config;
```

---

## ⚙️ 设置页面配置详解

### 配置入口

**路径**：Settings → Tools → AI Javadoc

### AI 提供商配置

#### 1. AI Provider（AI 提供商）

**作用**：选择使用的 AI 服务提供商

**选项**：

- **通义千问**：阿里云提供的大语言模型服务，支持中文和多语言处理
- **Ollama**：本地大语言模型运行环境，数据完全私有
- **自定义服务**：支持任何兼容 OpenAI API 接口的服务

**实现逻辑**：

- 通过 `AIServiceFactory.createProvider()` 根据选择创建对应的 Provider
- 不同 Provider 有不同的默认配置和 API 接口

#### 2. Base URL（服务地址）

**作用**：指定 AI 服务的 API 地址

**默认值**：

- **通义千问**：`https://dashscope.aliyuncs.com/compatible-mode/v1`
- **Ollama**：`http://localhost:11434/v1`
- **自定义服务**：用户自定义

**实现逻辑**：

- 存储在 `SettingsState.baseUrl` 中
- 用于构建 HTTP 请求的完整 URL
- 支持自定义端口和路径

#### 3. API Key（API 密钥）

**作用**：用于身份验证的 API 密钥

**要求**：

- **通义千问**：必须提供有效的 API Key
- **Ollama**：不需要 API Key（本地服务）
- **自定义服务**：根据服务要求

**实现逻辑**：

- 存储在 `SettingsState.apiKey` 中
- 在 HTTP 请求头中添加 `Authorization: Bearer {apiKey}`
- 支持动态启用/禁用输入框

#### 4. Model（模型名称）

**作用**：指定使用的 AI 模型

**推荐模型**：

- **通义千问**：`qwen-max`（最强大）、`qwen-plus`（性价比高）、`qwen-turbo`（速度最快）
- **Ollama**：`qwen:7b`、`codellama:7b`、`deepseek-coder:6.7b`
- **自定义服务**：根据服务支持的模型

**实现逻辑**：

- 支持下拉选择预设模型
- 支持手动输入自定义模型名称
- 通过 `refreshModelsButton` 获取服务商支持的模型列表

#### 5. Test Connection（测试连接）

**作用**：验证配置是否正确

**实现逻辑**：

- 创建临时的 AI 服务提供商实例
- 调用 `provider.validateConfiguration()` 方法
- 显示验证结果和详细信息
- 成功后标记配置为已验证

#### 6. Refresh Models（刷新模型）

**作用**：从服务提供商获取最新的可用模型列表

**实现逻辑**：

- 在后台线程中调用 `provider.getAvailableModels()`
- 更新模型下拉框的选项
- 保持用户当前选择的模型（如果仍然可用）

### 生成选项配置

#### 1. Generate for Class（为类生成文档）

**作用**：控制是否为类生成 JavaDoc 注释

**默认值**：启用

**实现逻辑**：

- 存储在 `SettingsState.generateForClass` 中
- 在 `TaskCollector.collectFromElement()` 中检查此配置
- 影响类、接口、枚举的文档生成

#### 2. Generate for Method（为方法生成文档）

**作用**：控制是否为方法生成 JavaDoc 注释

**默认值**：启用

**实现逻辑**：

- 存储在 `SettingsState.generateForMethod` 中
- 在任务收集时检查此配置
- 影响普通方法和测试方法的文档生成

#### 3. Generate for Field（为字段生成文档）

**作用**：控制是否为字段生成 JavaDoc 注释

**默认值**：启用

**实现逻辑**：

- 存储在 `SettingsState.generateForField` 中
- 在任务收集时检查此配置
- 影响类字段的文档生成

#### 4. Skip Existing（跳过已有文档的元素）

**作用**：控制是否跳过已有 JavaDoc 注释的元素

**默认值**：启用

**实现逻辑**：

- 存储在 `SettingsState.skipExisting` 中
- 在 `TaskCollector.shouldGenerateForElement()` 中检查
- 如果启用，已有 JavaDoc 的元素会被跳过
- 如果禁用，会重新生成所有元素的文档（智能替换）

#### 5. Optimize Class Code（优化类代码以减少 token 消耗）

**作用**：控制是否启用代码优化功能

**默认值**：启用

**实现逻辑**：

- 存储在 `SettingsState.optimizeClassCode` 中
- 在 `TaskCollector.getCodeWithComment()` 中应用
- 当类代码超过最大行数时，只发送部分代码给 AI
- 减少 API 调用成本，提高处理速度

#### 6. Max Class Code Lines（类代码最大行数）

**作用**：控制代码截取的行数限制

**默认值**：1000 行

**范围**：100-5000 行

**实现逻辑**：

- 存储在 `SettingsState.maxClassCodeLines` 中
- 与 `optimizeClassCode` 配置关联
- 只有在启用代码优化时才生效
- 通过 `JSpinner` 组件提供范围限制和步进控制

### 语言支持配置

#### 1. Java（Java 语言支持）

**作用**：启用 Java 语言的文档生成

**默认值**：启用

**实现逻辑**：

- 存储在 `SettingsState.supportedLanguages` 集合中
- 在任务收集时检查文件类型
- 目前是唯一支持的语言

#### 2. Kotlin（Kotlin 语言支持）

**作用**：启用 Kotlin 语言的文档生成

**默认值**：禁用（即将支持）

**实现逻辑**：

- 预留的配置项
- 为未来的 Kotlin 支持做准备
- 目前功能尚未实现

### 模型配置

#### 1. Max Tokens（最大 Token 数）

**作用**：控制 AI 响应的最大长度

**默认值**：1000

**范围**：100-10000

**实现逻辑**：

- 存储在 `SettingsState.maxTokens` 中
- 在构建 AI 请求时作为参数传递
- 影响生成文档的长度和质量

#### 2. Temperature（温度参数）

**作用**：控制 AI 生成的随机性和创造性

**默认值**：0.1

**范围**：0.0-2.0

**实现逻辑**：

- 存储在 `SettingsState.temperature` 中
- 较低值（0.1）生成更确定性的内容
- 较高值生成更有创造性的内容

#### 3. Top P（核采样参数）

**作用**：控制 AI 生成时的词汇选择范围

**默认值**：0.9

**范围**：0.0-1.0

**实现逻辑**：

- 存储在 `SettingsState.topP` 中
- 影响生成内容的多样性
- 与 temperature 参数配合使用

#### 4. Top K（Top-K 采样）

**作用**：限制 AI 选择词汇的范围

**默认值**：50

**范围**：1-100

**实现逻辑**：

- 存储在 `SettingsState.topK` 中
- 只考虑概率最高的 K 个词汇
- 影响生成内容的稳定性

#### 5. Presence Penalty（存在惩罚）

**作用**：减少重复内容的生成

**默认值**：0.1

**范围**：-2.0-2.0

**实现逻辑**：

- 存储在 `SettingsState.presencePenalty` 中
- 正值减少重复，负值增加重复
- 帮助生成更独特的文档

### 高级配置

#### 1. Max Retries（最大重试次数）

**作用**：控制 API 调用失败时的重试次数

**默认值**：3 次

**范围**：0-10 次

**实现逻辑**：

- 存储在 `SettingsState.maxRetries` 中
- 在 `OpenAICompatibleProvider.sendRequest()` 中应用
- 使用指数退避策略处理重试

#### 2. Timeout（超时时间）

**作用**：设置 API 调用的超时时间

**默认值**：30000 毫秒（30 秒）

**范围**：1000-300000 毫秒

**实现逻辑**：

- 存储在 `SettingsState.timeout` 中
- 在 HTTP 请求中设置连接和读取超时
- 防止长时间等待无响应

#### 3. Verbose Logging（详细日志）

**作用**：启用详细的调试日志

**默认值**：禁用

**实现逻辑**：

- 存储在 `SettingsState.verboseLogging` 中
- 控制日志输出的详细程度
- 用于调试和问题排查

#### 4. Performance Mode（性能模式）

**作用**：启用性能优化模式

**默认值**：禁用

**实现逻辑**：

- 存储在 `SettingsState.performanceMode` 中
- 可能影响某些功能的性能表现
- 为未来的性能优化预留

### Prompt 模板配置

#### 1. System Prompt（系统提示词）

**作用**：定义 AI 的基本行为和角色

**默认值**：

```
你是一个专业的 Java 开发工程师，请为以下代码生成 JavaDoc 注释（中文）。

要求：
1. 必须包含完整的 JavaDoc 格式，包括开始标记 /** 和结束标记 */
2. 使用中文编写注释内容
3. 只返回 JavaDoc 注释本身，不要包含任何 markdown 标记（如 ```java 或 ```）
4. 不要重复代码，只返回注释部分
5. 注释要准确描述代码的功能、参数、返回值等信息
```

**实现逻辑**：

- 存储在 `SettingsState.systemPromptTemplate` 中
- 在所有文档生成请求中使用
- 定义 AI 的基本行为规范

#### 2. Class Prompt（类提示词）

**作用**：专门用于生成类文档的提示词

**默认值**：

```
你是一个专业的 Java 开发工程师，请为以下类生成 JavaDoc 注释（中文）。

要求：
1. 必须包含完整的 JavaDoc 格式，包括开始标记 /** 和结束标记 */
2. 使用中文编写注释内容
3. 只返回 JavaDoc 注释本身，不要包含任何 markdown 标记（如 ```java 或 ```）
4. 不要重复代码，只返回注释部分
5. 注释要准确描述类的职责、功能和使用场景
6. 如果是工具类，说明主要功能和使用方法
7. 如果是业务类，说明业务职责和设计意图
8. 如果是设计模式相关类，说明设计模式类型和作用

代码：
%s

JavaDoc 注释：
```

**实现逻辑**：

- 存储在 `SettingsState.classPromptTemplate` 中
- 用于类、接口、枚举的文档生成
- 强调类的职责和设计意图

#### 3. Method Prompt（方法提示词）

**作用**：专门用于生成方法文档的提示词

**默认值**：

```
你是一个专业的 Java 开发工程师，请为以下方法生成 JavaDoc 注释（中文）。

要求：
1. 必须包含完整的 JavaDoc 格式，包括开始标记 /** 和结束标记 */
2. 使用中文编写注释内容
3. 只返回 JavaDoc 注释本身，不要包含任何 markdown 标记（如 ```java 或 ```）
4. 不要重复代码，只返回注释部分
5. 注释要准确描述方法的功能、参数、返回值、异常等信息
6. 使用标准的 JavaDoc 标签：@param、@return、@throws 等
7. 对于复杂逻辑，说明实现思路和注意事项

代码：
%s

JavaDoc 注释：
```

**实现逻辑**：

- 存储在 `SettingsState.methodPromptTemplate` 中
- 用于普通方法的文档生成
- 强调参数、返回值、异常等详细信息

#### 4. Field Prompt（字段提示词）

**作用**：专门用于生成字段文档的提示词

**默认值**：

```
你是一个专业的 Java 开发工程师，请为以下字段生成 JavaDoc 注释（中文）。

要求：
1. 必须返回完整的 JavaDoc 格式，包括开始标记 /** 和结束标记 */
2. 使用中文编写注释内容
3. 只返回 JavaDoc 注释本身，不要包含任何 markdown 标记（如 ```java 或 ```）
4. 不要重复代码，只返回注释部分
5. 注释要准确描述字段的用途和含义
6. **格式规则（重要）**：
   - 如果字段说明简单（不超过 80 个字符，没有 @tag 标签），必须使用单行格式：/** 字段说明 */
   - 如果字段说明复杂（包含多个信息点、有 @tag 标签、或超过 80 个字符），使用多行格式

示例：
简单字段：
private String username;
返回：/** 用户名 */

简单字段：
private String code;
返回：/** 登陆时的验证码，比如：手机上收到的那个码 */

复杂字段：
private UserConfig config;
返回：
/**
 * 用户配置信息
 * 
 * <p>包含用户偏好设置、主题配置等
 * 
 * @see UserConfig
 */

代码：
%s

JavaDoc 注释：
```

**实现逻辑**：

- 存储在 `SettingsState.fieldPromptTemplate` 中
- 用于字段的文档生成
- 强调单行/多行格式的智能选择

#### 5. Test Prompt（测试方法提示词）

**作用**：专门用于生成测试方法文档的提示词

**默认值**：

```
你是一个专业的 Java 开发工程师，请为以下测试方法生成 JavaDoc 注释（中文）。

要求：
1. 必须包含完整的 JavaDoc 格式，包括开始标记 /** 和结束标记 */
2. 使用中文编写注释内容
3. 只返回 JavaDoc 注释本身，不要包含任何 markdown 标记（如 ```java 或 ```）
4. 不要重复代码，只返回注释部分
5. 注释要准确描述测试的目标、场景、预期结果等
6. 说明测试覆盖的业务场景和边界条件
7. 对于复杂测试，说明测试策略和验证要点

代码：
%s

JavaDoc 注释：
```

**实现逻辑**：

- 存储在 `SettingsState.testPromptTemplate` 中
- 用于 JUnit 测试方法的文档生成
- 强调测试目标和验证场景

### 配置管理

#### 配置持久化

**实现方式**：

- 使用 IntelliJ Platform 的 `PersistentStateComponent` 机制
- 配置保存在 IDE 配置目录的 `JavaDocAI.xml` 文件中
- 支持跨会话保持配置

#### 配置验证

**验证机制**：

- 通过 `Test Connection` 按钮验证 AI 服务配置
- 验证成功后标记配置为已验证
- 未验证的配置会在使用时提示用户

#### 配置重置

**重置功能**：

- 每个 Prompt 模板都有 `Reset` 按钮
- 可以恢复到默认的 Prompt 模板
- 支持部分重置和完全重置

---

## 👨‍💻 开发者指南

### 架构概览

插件采用分层架构设计，各层职责清晰：

```
┌─────────────────────────────────────────────────────────────┐
│                      IntelliJ IDEA                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                   用户界面层                          │  │
│  │  - 快捷键: Ctrl+Shift+D / Cmd+Shift+D                │  │
│  │  - 编辑器右键菜单                                      │  │
│  │  - 文件/目录右键菜单                                   │  │
│  │  - Generate 菜单 (Cmd+N / Alt+Insert)                │  │
│  └────────────────┬─────────────────────────────────────┘  │
│                   │                                          │
│  ┌────────────────▼─────────────────────────────────────┐  │
│  │                   动作层 (Actions)                    │  │
│  │  - GenerateJavaDocShortcutAction (快捷键入口)         │  │
│  │  - GenerateJavaDocForFileAction (编辑器右键)         │  │
│  │  - GenerateJavaDocForSelectionAction (文件/目录右键) │  │
│  │  - GenerateJavaDocGenerateAction (Generate 菜单)     │  │
│  │  - GenerateJavaDocIntentionAction (Intention Action)│  │
│  └────────────────┬─────────────────────────────────────┘  │
│                   │                                          │
│  ┌────────────────▼─────────────────────────────────────┐  │
│  │                 任务处理层 (Tasks)                    │  │
│  │  - TaskCollector (收集需要生成文档的任务)            │  │
│  │  - TaskExecutor (异步执行任务队列)                   │  │
│  │  - DocumentationTask (任务数据结构)                  │  │
│  └────────────────┬─────────────────────────────────────┘  │
│                   │                                          │
│  ┌────────────────▼─────────────────────────────────────┐  │
│  │               AI 服务层 (AI Services)                 │  │
│  │  - AIServiceFactory (创建 Provider)                  │  │
│  │  - AIServiceProvider (接口)                          │  │
│  │  - OpenAICompatibleProvider (抽象实现)               │  │
│  │      ├─ QianWenProvider (通义千问)                   │  │
│  │      ├─ OllamaProvider (Ollama 本地)                 │  │
│  │      └─ CustomProvider (自定义服务)                  │  │
│  └────────────────┬─────────────────────────────────────┘  │
│                   │                                          │
│  ┌────────────────▼─────────────────────────────────────┐  │
│  │               配置管理层 (Settings)                   │  │
│  │  - SettingsState (配置持久化)                        │  │
│  │  - JavaDocSettingsConfigurable (配置面板)           │  │
│  │  - JavaDocSettingsPanel (UI 组件)                   │  │
│  └────────────────┬─────────────────────────────────────┘  │
│                   │                                          │
└───────────────────┼──────────────────────────────────────────┘
                    │
        ┌───────────▼───────────┐
        │    外部 AI 服务       │
        │  - 通义千问 API       │
        │  - Ollama (本地)     │
        │  - 自定义服务        │
        └───────────────────────┘
```

### 核心组件

#### 1. 动作层 (Actions)

**职责**：处理用户交互，作为插件的入口点

**主要类**：

- `GenerateJavaDocShortcutAction`：快捷键入口
- `GenerateJavaDocForFileAction`：编辑器右键菜单
- `GenerateJavaDocForSelectionAction`：文件/目录右键菜单
- `GenerateJavaDocGenerateAction`：Generate 菜单
- `GenerateJavaDocIntentionAction`：Intention Action

**共同模式**：

```java
@Override
public void actionPerformed(@NotNull AnActionEvent e) {
    // 1. 获取编辑器和文件
    Editor editor = e.getData(CommonDataKeys.EDITOR);
    PsiFile psiFile = e.getData(CommonDataKeys.PSI_FILE);
    
    // 2. 智能定位
    PsiElementLocator.LocateResult locateResult = 
        PsiElementLocator.locateElement(editor, psiFile);
    
    // 3. 根据定位结果收集任务
    TaskCollector collector = new TaskCollector(project);
    List<DocumentationTask> tasks = collector.collectFromElement(locateResult.getElement());
    
    // 4. 执行任务
    TaskExecutor executor = new TaskExecutor(project, indicator);
    executor.processTasks(tasks);
}
```

#### 2. 任务处理层 (Tasks)

**职责**：收集和执行文档生成任务

**TaskCollector**：

- 从不同来源收集任务（元素、文件、目录）
- 根据配置过滤需要处理的元素
- 创建 DocumentationTask 对象
- 支持递归处理内部类和目录结构

**TaskExecutor**：

- 异步执行任务队列
- 实时更新进度
- 支持取消操作
- 错误隔离（单个失败不影响其他）
- 自动格式化生成的 JavaDoc

**DocumentationTask**：

- 任务数据结构
- 包含 PSI 元素、代码片段、任务类型、状态等信息

#### 3. AI 服务层 (AI Services)

**职责**：与 AI 服务交互

**AIServiceProvider**：定义 AI 服务的标准接口

```java
public interface AIServiceProvider {
    String generateDocumentation(String code, DocumentationType type, String language);
    boolean validateConfiguration();
    List<String> getSupportedModels();
    String getDefaultModel();
}
```

**OpenAICompatibleProvider**：OpenAI 兼容 API 的通用实现

- HTTP 请求处理
- Prompt 模板加载
- 响应解析
- 错误处理和重试机制

**具体实现**：

- `QianWenProvider`：通义千问的具体实现
- `OllamaProvider`：Ollama 本地模型的具体实现
- `CustomProvider`：自定义服务的具体实现

#### 4. 配置管理层 (Settings)

**职责**：配置的持久化和 UI

**SettingsState**：配置持久化

- 使用 `@State` 注解标记
- 实现 `PersistentStateComponent` 接口
- 支持配置的保存和加载

**JavaDocSettingsConfigurable**：连接设置面板和状态

- 实现 `Configurable` 接口
- 管理设置面板的生命周期

**JavaDocSettingsPanel**：设置 UI 组件

- 包含所有配置项的 UI 组件
- 支持配置的获取和加载
- 提供配置验证功能

### 工作流程

#### 用户触发生成

```
1. 用户触发 (快捷键/右键菜单)
   ↓
2. Action 获取当前文件/选择
   ↓
3. PsiElementLocator 智能定位元素
   ↓
4. TaskCollector 收集任务
   - 遍历 PSI 树
   - 识别类、方法、测试方法
   - 过滤已有文档的元素
   - 创建 DocumentationTask 列表
   ↓
5. 显示进度对话框
   ↓
6. TaskExecutor 在后台处理
   - 遍历任务列表
   - 为每个任务：
     a. 更新进度 (X/Y completed)
     b. 检查是否取消
     c. 调用 AI 生成文档
     d. 插入文档到代码
     e. 自动格式化
     f. 更新统计
   ↓
7. 显示结果统计
   - 完成: X
   - 失败: Y
   - 跳过: Z
```

#### AI 文档生成流程

```
1. TaskExecutor.processTask(task)
   ↓
2. AIServiceFactory.createProvider(settings)
   - 根据设置创建对应的 Provider
   ↓
3. Provider.generateDocumentation(code, type, language)
   ↓
4. 从设置加载 Prompt 模板
   - settings.methodPromptTemplate (方法/类)
   - settings.testPromptTemplate (测试方法)
   - settings.fieldPromptTemplate (字段)
   - settings.classPromptTemplate (类)
   ↓
5. 构建完整 Prompt
   - String.format(template, code)
   ↓
6. 发送 HTTP 请求
   - buildHeaders() (添加 Authorization)
   - buildRequestBody() (构建 JSON)
   - sendRequest() (发送请求)
   - 重试机制 (指数退避)
   ↓
7. 解析响应
   - parseResponse() (提取内容)
   - 清理 Markdown 标记
   ↓
8. 返回生成的 JavaDoc
   ↓
9. 插入到文档
   - 在写入线程中执行
   - 自动格式化 (CodeStyleManager)
   ↓
10. 更新任务状态
```

### 扩展指南

#### 添加新的 AI 提供商

**步骤 1**：创建 Provider 类

```java
public class MyAIProvider extends OpenAICompatibleProvider {
    
    public MyAIProvider(SettingsState settings) {
        super(settings);
    }
    
    @Override
    public String getProviderId() {
        return "myai";
    }
    
    @Override
    public String getProviderName() {
        return "My AI Service";
    }
    
    @Override
    public String getDefaultBaseUrl() {
        return "https://api.myai.com/v1";
    }
    
    @Override
    public List<String> getSupportedModels() {
        return Arrays.asList("model-1", "model-2");
    }
    
    @Override
    public boolean requiresApiKey() {
        return true;
    }
}
```

**步骤 2**：注册到 Factory

```java
// AIServiceFactory.java
public static AIServiceProvider createProvider(SettingsState settings) {
    switch (settings.aiProvider) {
        case "qianwen": return new QianWenProvider(settings);
        case "ollama": return new OllamaProvider(settings);
        case "myai": return new MyAIProvider(settings);  // 添加这行
        default: throw new IllegalArgumentException(...);
    }
}
```

**步骤 3**：更新设置面板

```java
// JavaDocSettingsPanel.java
providerComboBox = new ComboBox<>(new String[]{"qianwen", "ollama", "myai"});
```

#### 添加新的语言支持

**步骤 1**：更新设置

```java
// SettingsState.java
public Set<String> supportedLanguages = new HashSet<String>() {{
    add("java");
    add("kotlin");  // 添加新语言
}};
```

**步骤 2**：创建语言特定的 Prompt

```java
// SettingsState.java
public String kotlinPromptTemplate = "...";
```

**步骤 3**：更新 TaskCollector

```java
// TaskCollector.java
public List<DocumentationTask> collectFromFile(PsiFile file) {
    if (file instanceof PsiJavaFile) {
        // Java 处理逻辑
    } else if (file instanceof KtFile) {  // Kotlin
        // Kotlin 处理逻辑
    }
}
```

### 设计模式

1. **工厂模式** - `AIServiceFactory`
2. **策略模式** - `AIServiceProvider` 接口
3. **模板方法** - `OpenAICompatibleProvider`
4. **访问者模式** - PSI 元素遍历
5. **状态模式** - `DocumentationTask.TaskStatus`

### 技术特点

- ✅ **分层架构**：清晰的职责分离
- ✅ **接口抽象**：易于扩展和测试
- ✅ **异步处理**：不阻塞 UI
- ✅ **依赖注入**：低耦合
- ✅ **配置化**：灵活可定制

---

## ❓ 常见问题解答

### Q: 为什么插件没有反应？

**A**: 请检查以下几点：

1. **确保已正确配置 AI 提供商**
2. **确认当前文件是 Java 文件**
3. **检查 IDE 是否正在索引**（状态栏显示索引进度）
4. **查看 IDE 日志中的错误信息**
5. **确保配置已通过连接测试**

### Q: 如何查看 API 调用失败的原因？

**A**: 查看 IDE 日志文件：

- **macOS**: `~/Library/Logs/JetBrains/IntelliJIdea<Version>/idea.log`
- **Windows**: `%USERPROFILE%\AppData\Local\JetBrains\IntelliJIdea<Version>\log\idea.log`
- **Linux**: `~/.cache/JetBrains/IntelliJIdea<Version>/log/idea.log`

### Q: 如何自定义 Prompt 模板？

**A**: 在设置面板的 "Prompt Template Configuration" 部分可以自定义：

- **System Prompt**：系统提示词模板
- **Class Prompt**：类文档模板
- **Method Prompt**：方法文档模板
- **Field Prompt**：字段文档模板
- **Test Method Prompt**：测试方法文档模板

使用 `%s` 作为代码占位符

### Q: 支持哪些测试框架？

**A**: 目前支持：

- **JUnit 4** (`@org.junit.Test`)
- **JUnit 5** (`@org.junit.jupiter.api.Test`)

### Q: 如何选择 AI 提供商？

**A**: 根据您的需求选择：

- **通义千问**：适合中文文档生成，需要 API Key，有使用成本
- **Ollama**：本地运行，数据私有，无需 API Key，需要足够的系统资源
- **自定义服务**：支持任何兼容 OpenAI API 的服务

### Q: 如何批量重新生成所有注释？

**A**: 操作步骤：

1. **取消勾选** "跳过已有文档的元素" 选项
2. 右键点击项目根目录
3. 选择 "Generate JavaDoc with AI for Directory"
4. 等待处理完成

### Q: 智能定位功能如何工作？

**A**: 插件会根据光标位置智能决定生成范围：

- **光标在方法上** → 只为该方法生成
- **光标在字段上** → 只为该字段生成
- **光标在类声明上** → 只为该类生成
- **光标在类内部（但不在特定成员上）** → 为整个类及所有成员生成
- **其他情况** → 为整个文件生成

### Q: 如何配置字段的单行/多行格式？

**A**: 在字段 Prompt 模板中可以自定义规则：

```
- 如果字段说明简单（不超过 80 个字符，没有 @tag 标签），必须使用单行格式：/** 字段说明 */
- 如果字段说明复杂（包含多个信息点、有 @tag 标签、或超过 80 个字符），使用多行格式
```

可以修改字符数限制来调整规则。

### Q: 插件支持哪些 IntelliJ IDEA 版本？

**A**: 插件支持：

- **IntelliJ IDEA 2022.3** 及以上版本
- **Android Studio** 兼容版本
- **其他基于 IntelliJ Platform 的 IDE**

### Q: 如何提高生成质量？

**A**: 建议：

1. **选择合适的 AI 模型**（推荐通义千问的 `qwen-max`）
2. **自定义 Prompt 模板**，根据项目特点调整
3. **调整模型参数**（temperature、maxTokens 等）
4. **提供更多上下文**，确保代码完整

### Q: 如何处理生成失败的情况？

**A**: 插件提供多种处理方式：

1. **自动重试**：配置的重试次数内自动重试
2. **错误隔离**：单个失败不影响其他任务
3. **详细日志**：记录失败原因供排查
4. **手动重试**：可以单独重新生成失败的文档

---

## 📚 相关文档

- [项目技术解析文档](docs/项目技术解析文档.md) - 详细的技术架构和实现说明
- [IDEA Plugin 开发文档](docs/IDEA_Plugin_开发文档.md) - IntelliJ IDEA 插件开发完整指南
- [v2.0架构说明](docs/v2.0架构说明.md) - v2.0 架构设计文档
- [v2.1特性实现说明](docs/v2.1特性实现说明.md) - v2.1 新特性实现说明
- [智能定位功能说明](docs/智能定位功能说明.md) - 智能定位功能详解
- [注释替换功能说明](docs/注释替换功能说明.md) - 智能注释替换功能详解

---

## 🎉 总结

IntelliJ AI Javadoc 插件通过智能的 AI 技术，为 Java 开发者提供了便捷、高效的文档生成解决方案。无论是单个元素的精确生成，还是大规模项目的批量处理，插件都能提供出色的用户体验。

通过合理的架构设计和丰富的配置选项，插件既满足了普通用户的日常需求，也为高级用户提供了充分的定制空间。智能定位、注释替换、字段格式化等创新功能，让文档生成变得更加智能和高效。

希望这份操作手册能帮助您更好地使用和配置插件，提高开发效率，生成高质量的代码文档！
