# IntelliJ AI Javadoc 插件 - 测试说明

## 📋 测试概述

本项目已为核心功能添加了完整的单元测试，覆盖以下模块：

- ✅ **SettingsState** - 配置管理测试
- ✅ **DocumentationTask** - 任务管理测试
- ✅ **AIServiceFactory** - AI 服务工厂测试
- ✅ **NotificationUtil** - 通知工具测试
- ✅ **PsiElementLocator** - PSI 元素定位器测试
- ✅ **TaskCollector** - 任务收集器测试

## 🛠️ 测试技术栈

- **测试框架**: JUnit 5 (Jupiter)
- **Mock 框架**: Mockito 5.2.0
- **断言库**: AssertJ 3.24.2
- **IntelliJ 测试框架**: IntelliJ Platform Test Framework

## 📦 测试结构

```
src/test/java/com/github/intellijjavadocai/
├── ai/
│   └── AIServiceFactoryTest.java          # AI 服务工厂测试
├── settings/
│   └── SettingsStateTest.java             # 配置状态测试
├── task/
│   ├── DocumentationTaskTest.java         # 文档任务测试
│   └── TaskCollectorTest.java             # 任务收集器测试
└── util/
    ├── NotificationUtilTest.java          # 通知工具测试
    └── PsiElementLocatorTest.java         # PSI 元素定位器测试
```

## 🚀 运行测试

### 1. 使用 Gradle 运行所有测试

```bash
./gradlew test
```

### 2. 运行特定的测试类

```bash
./gradlew test --tests "dev.dong4j.zeka.stack.idea.plugin.settings.SettingsStateTest"
```

### 3. 运行特定的测试方法

```bash
./gradlew test --tests "dev.dong4j.zeka.stack.idea.plugin.settings.SettingsStateTest.testDefaultValues"
```

### 4. 在 IntelliJ IDEA 中运行

- 右键点击测试类或测试方法
- 选择 "Run 'TestClassName'" 或 "Run 'testMethodName()'"
- 或使用快捷键 `Ctrl + Shift + F10` (Windows/Linux) 或 `⌘ + Shift + R` (macOS)

## 📊 测试覆盖率

### SettingsStateTest (25 个测试用例)

- ✅ 默认配置值验证
- ✅ 配置有效性检查
- ✅ API Key 需求验证
- ✅ 语言支持检测
- ✅ 配置重置和复制
- ✅ Prompt 模板验证
- ✅ 持久化状态测试

### DocumentationTaskTest (18 个测试用例)

- ✅ 任务创建和状态管理
- ✅ 任务生命周期测试
- ✅ 所有任务类型验证
- ✅ 任务状态转换测试
- ✅ 错误处理测试
- ✅ 元素名称格式化测试

### AIServiceFactoryTest (17 个测试用例)

- ✅ 创建不同 AI 提供商
- ✅ 提供商支持检测
- ✅ 提供商配置验证
- ✅ 多实例创建测试
- ✅ 提供商切换测试
- ✅ 异常处理测试

### NotificationUtilTest (13 个测试用例)

- ✅ 信息/警告/错误通知
- ✅ 完成通知（不同状态）
- ✅ 目标完成通知
- ✅ 无任务通知
- ✅ 索引中通知
- ✅ Null project 处理

### PsiElementLocatorTest (23 个测试用例)

- ✅ 元素定位测试
- ✅ JavaDoc 检测
- ✅ 元素描述生成
- ✅ 类型描述验证
- ✅ LocateResult 功能测试
- ✅ 边界条件处理

### TaskCollectorTest (20 个测试用例)

- ✅ 从不同元素收集任务
- ✅ 测试方法识别（JUnit 4/5）
- ✅ 跳过已有文档
- ✅ 配置项启用/禁用
- ✅ 文件和目录遍历
- ✅ 内部类处理

**总计**: **116+ 个测试用例**

## 🔍 测试要点

### 1. Mock 使用

测试中广泛使用 Mockito 来模拟 IntelliJ Platform 的 API：

```java
@Mock
private Project mockProject;

@Mock
private PsiMethod mockMethod;

@BeforeEach
void setUp() {
    MockitoAnnotations.openMocks(this);
    when(mockMethod.getName()).thenReturn("testMethod");
}
```

### 2. 静态方法 Mock

使用 MockedStatic 来模拟静态方法：

```java
try (MockedStatic<NotificationGroupManager> mockedStatic = 
        mockStatic(NotificationGroupManager.class)) {
    mockedStatic.when(NotificationGroupManager::getInstance)
        .thenReturn(mockGroupManager);
    // 测试代码
}
```

### 3. AssertJ 断言

使用 AssertJ 提供流畅的断言 API：

```java
assertThat(settings.aiProvider).isEqualTo("qianwen");
assertThat(tasks).hasSize(3);
assertThat(result.isMethod()).isTrue();
```

## 📝 测试命名规范

所有测试方法遵循以下命名规范：

```
test<功能名称>_<测试场景>
```

例如：

- `testIsValid_withValidConfiguration` - 测试有效配置的验证
- `testCollectFromElement_method` - 测试从方法收集任务
- `testNotifyCompletion_withFailures` - 测试有失败的完成通知

## 🐛 常见问题

### Q1: 测试运行时出现 ClassNotFoundException

**解决方案**: 确保已安装所有依赖

```bash
./gradlew clean build
```

### Q2: Mock 对象返回 null

**解决方案**: 检查是否正确配置了 mock 对象的行为

```java
when(mockMethod.getText()).thenReturn("public void test() {}");
```

### Q3: IntelliJ Platform API 相关错误

**解决方案**: 确保在 `build.gradle.kts` 中添加了测试框架依赖：

```kotlin
intellijPlatform {
    testFramework(org.jetbrains.intellij.platform.gradle.TestFrameworkType.Platform)
}
```

## 📈 持续改进

### 待添加的测试

1. **集成测试**: 测试完整的工作流程
2. **性能测试**: 测试大量任务处理性能
3. **AI Provider 测试**: 为具体的 AI Provider 实现添加测试
4. **Action 测试**: 为用户操作（Action）添加测试

### 测试最佳实践

1. ✅ **每个测试只测试一个功能点**
2. ✅ **使用描述性的测试名称**
3. ✅ **使用 @DisplayName 提供中文描述**
4. ✅ **测试边界条件和异常情况**
5. ✅ **保持测试的独立性**
6. ✅ **使用 @BeforeEach 进行初始化**

## 🎯 测试覆盖目标

- [x] 核心业务逻辑: **100%**
- [x] 工具类: **100%**
- [ ] UI 相关代码: **待添加**
- [ ] Action 相关代码: **待添加**

## 📚 参考资料

- [JUnit 5 用户指南](https://junit.org/junit5/docs/current/user-guide/)
- [Mockito 文档](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)
- [AssertJ 文档](https://assertj.github.io/doc/)
- [IntelliJ Platform SDK 测试指南](https://plugins.jetbrains.com/docs/intellij/testing-plugins.html)


