# IntelliJ AI Javadoc æ’ä»¶ - é›†æˆæµ‹è¯•è¯´æ˜

## ğŸ“š æµ‹è¯•æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»äº†æ’ä»¶çš„é›†æˆæµ‹è¯•ï¼Œç‰¹åˆ«æ˜¯ï¼š

1. **JavaDoc æ›¿æ¢é€»è¾‘æµ‹è¯•** - ä½¿ç”¨ IntelliJ Platform Test Framework
2. **AI HTTP è°ƒç”¨æµ‹è¯•** - ä½¿ç”¨ MockWebServer æ¨¡æ‹ŸçœŸå® API

è¿™äº›æµ‹è¯•å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ IntelliJ Platform SDK çš„æ ¸å¿ƒ APIï¼Œæ˜¯å­¦ä¹ æ’ä»¶å¼€å‘çš„ç»ä½³ç¤ºä¾‹ã€‚

## ğŸ¯ æµ‹è¯•æ–‡ä»¶

### 1. BasePlatformTestCase - æµ‹è¯•åŸºç±»

**æ–‡ä»¶**: `src/test/java/com/github/intellijjavadocai/BasePlatformTestCase.java`

**ä½œç”¨**: æä¾›é€šç”¨çš„æµ‹è¯•å·¥å…·æ–¹æ³•

**å…³é”®å­¦ä¹ ç‚¹**:

#### 1.1 IntelliJ Platform çš„ Read/Write Action

```java
// è¯»æ“ä½œ - æ‰€æœ‰ PSI è¯»å–å¿…é¡»åœ¨ Read Action ä¸­
protected <T> T runReadAction(@NotNull Computable<T> computation) {
    return ApplicationManager.getApplication().runReadAction(computation);
}

// å†™æ“ä½œ - æ‰€æœ‰ PSI ä¿®æ”¹å¿…é¡»åœ¨ Write Action ä¸­
protected void runWriteAction(@NotNull Runnable runnable) {
    WriteCommandAction.runWriteCommandAction(getProject(), runnable);
}
```

**ä¸ºä»€ä¹ˆéœ€è¦**:

- IntelliJ Platform æ˜¯å¤šçº¿ç¨‹çš„
- Read Action ç¡®ä¿è¯»å–æ—¶ PSI æ ‘ä¸è¢«ä¿®æ”¹
- Write Action é”å®š PSI æ ‘ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨

#### 1.2 Document å’Œ PSI çš„åŒæ­¥

```java
// è·å– Documentï¼ˆç¼–è¾‘å™¨è§†å›¾ï¼‰
protected Document getDocument(@NotNull PsiFile file) {
    return FileDocumentManager.getInstance().getDocument(file.getVirtualFile());
}

// æäº¤ Document å˜æ›´åˆ° PSIï¼ˆè¯­ä¹‰æ ‘ï¼‰
protected void commitDocument(@NotNull PsiFile file) {
    Document document = getDocument(file);
    PsiDocumentManager.getInstance(getProject()).commitDocument(document);
}
```

**æ ¸å¿ƒæ¦‚å¿µ**:

- **Document**: æ–‡æœ¬æ–‡ä»¶çš„ç¼–è¾‘å™¨è¡¨ç¤ºï¼ˆå­—ç¬¦æµï¼‰
- **PSI**: ä»£ç çš„è¯­ä¹‰æ ‘è¡¨ç¤ºï¼ˆè¯­æ³•æ ‘ï¼‰
- ä¿®æ”¹ Document åå¿…é¡»è°ƒç”¨ `commitDocument` åŒæ­¥åˆ° PSI

#### 1.3 åˆ›å»ºæµ‹è¯•æ–‡ä»¶

```java
protected PsiJavaFile createJavaFile(@NotNull String fileName, @NotNull String content) {
    // fixture æ˜¯æµ‹è¯•æ¡†æ¶çš„æ ¸å¿ƒå·¥å…·
    PsiFile file = myFixture.configureByText(fileName, content);
    return (PsiJavaFile) file;
}
```

**fixture æä¾›çš„åŠŸèƒ½**:

- åˆ›å»ºä¸´æ—¶é¡¹ç›®
- ç®¡ç†æµ‹è¯•æ–‡ä»¶
- æä¾›ç¼–è¾‘å™¨ç¯å¢ƒ
- å¤„ç†æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

### 2. TaskExecutorIntegrationTest - JavaDoc æ›¿æ¢é€»è¾‘æµ‹è¯•

**æ–‡ä»¶**: `src/test/java/com/github/intellijjavadocai/task/TaskExecutorIntegrationTest.java`

**æµ‹è¯•åœºæ™¯**:

1. âœ… ä¸ºæ²¡æœ‰ JavaDoc çš„æ–¹æ³•æ’å…¥æ³¨é‡Š
2. âœ… æ›¿æ¢å·²æœ‰çš„ JavaDoc æ³¨é‡Š
3. âœ… ä¸ºç±»æ·»åŠ  JavaDoc
4. âœ… ä¸ºå­—æ®µæ·»åŠ  JavaDoc
5. âœ… æ‰¹é‡å¤„ç†å¤šä¸ªä»»åŠ¡
6. âœ… è·³è¿‡å·²æœ‰æ–‡æ¡£çš„åŠŸèƒ½

#### 2.1 å…³é”®å­¦ä¹ ç‚¹ï¼šPSI å…ƒç´ æ“ä½œ

##### è·å– PSI å…ƒç´ 

```java
// è·å–ç±»
PsiClass[] classes = file.getClasses();

// è·å–æ–¹æ³•
PsiMethod[] methods = psiClass.getMethods();

// è·å–å­—æ®µ
PsiField[] fields = psiClass.getFields();

// è·å– JavaDoc
PsiDocComment docComment = method.getDocComment();
```

##### éå† PSI æ ‘

```java
// ä½¿ç”¨ Visitor æ¨¡å¼éå† PSI æ ‘
file.accept(new JavaRecursiveElementVisitor() {
    @Override
    public void visitClass(PsiClass aClass) {
        // å¤„ç†ç±»
        super.visitClass(aClass);
    }
    
    @Override
    public void visitMethod(PsiMethod method) {
        // å¤„ç†æ–¹æ³•
        super.visitMethod(method);
    }
});
```

#### 2.2 æµ‹è¯•ç¤ºä¾‹ï¼šæ’å…¥ JavaDoc

```java
@Test
public void testInsertJavaDocForMethodWithoutExistingComment() {
    // 1. åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    String code = """
        public class TestClass {
            public String getUserName(int userId) {
                return "user_" + userId;
            }
        }
        """;
    PsiJavaFile file = createJavaFile("TestClass.java", code);
    
    // 2. è·å–æ–¹æ³•å…ƒç´ ï¼ˆåœ¨ Read Action ä¸­ï¼‰
    PsiMethod method = runReadAction(() -> {
        PsiClass[] classes = file.getClasses();
        return classes[0].getMethods()[0];
    });
    
    // 3. éªŒè¯æ²¡æœ‰ JavaDoc
    Boolean hasDoc = runReadAction(() -> 
        method.getDocComment() != null);
    assertFalse("Method should not have JavaDoc", hasDoc);
    
    // 4. åˆ›å»ºä»»åŠ¡å¹¶æ‰§è¡Œ
    String methodCode = runReadAction(() -> method.getText());
    DocumentationTask task = new DocumentationTask(
        method, methodCode, 
        DocumentationTask.TaskType.METHOD,
        file.getVirtualFile().getPath()
    );
    
    taskExecutor.processTasks(Arrays.asList(task));
    
    // 5. ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
    waitForPendingWrites();
    
    // 6. éªŒè¯ JavaDoc è¢«æ’å…¥
    String updatedContent = getFileText(file);
    assertTrue("Should have JavaDoc", 
        updatedContent.contains("/**"));
}
```

#### 2.3 Mock AI Service

ä¸ºäº†æµ‹è¯•ä¸ä¾èµ–çœŸå® APIï¼Œä½¿ç”¨ Mock AI Serviceï¼š

```java
private static class MockAIServiceProvider implements AIServiceProvider {
    @Override
    public String generateDocumentation(String code, 
                                       DocumentationType type,
                                       String language) {
        // æ ¹æ®ä»£ç å†…å®¹è¿”å›ä¸åŒçš„ Mock ç»“æœ
        if (code.contains("getUserName")) {
            return """
                /**
                 * æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·åç§°
                 * @param userId ç”¨æˆ·ID
                 * @return ç”¨æˆ·åç§°
                 */
                """;
        }
        return "/** Mock JavaDoc */";
    }
    // ... å…¶ä»–æ–¹æ³•
}
```

**æ³¨å…¥ Mock Service**:

```java
private void injectMockAIService(TaskExecutor executor) {
    try {
        Field field = TaskExecutor.class
            .getDeclaredField("aiService");
        field.setAccessible(true);
        field.set(executor, new MockAIServiceProvider());
    } catch (Exception e) {
        throw new RuntimeException("Failed to inject", e);
    }
}
```

#### 2.4 å¼‚æ­¥æ“ä½œå¤„ç†

IntelliJ Platform çš„å¾ˆå¤šæ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œæµ‹è¯•ä¸­éœ€è¦ç­‰å¾…ï¼š

```java
private void waitForPendingWrites() {
    // 1. æäº¤æ‰€æœ‰ Document å˜æ›´
    PsiDocumentManager.getInstance(getProject())
        .commitAllDocuments();
    
    // 2. å¤„ç† EDT é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡
    UIUtil.dispatchAllInvocationEvents();
    
    // 3. ç¨å¾®ç­‰å¾…ç¡®ä¿å®Œæˆ
    Thread.sleep(100);
}
```

### 3. AIProviderHttpIntegrationTest - HTTP è°ƒç”¨æµ‹è¯•

**æ–‡ä»¶**: `src/test/java/com/github/intellijjavadocai/ai/AIProviderHttpIntegrationTest.java`

**æµ‹è¯•åœºæ™¯**:

1. âœ… æˆåŠŸçš„ HTTP è¯·æ±‚å’Œå“åº”
2. âœ… 401 æœªæˆæƒé”™è¯¯
3. âœ… 429 è¯·æ±‚è¿‡å¤šé”™è¯¯ï¼ˆRate Limitï¼‰
4. âœ… 500 æœåŠ¡å™¨é”™è¯¯
5. âœ… é‡è¯•æœºåˆ¶
6. âœ… ç½‘ç»œè¿æ¥é”™è¯¯
7. âœ… å“åº”è§£æé”™è¯¯
8. âœ… Ollama Providerï¼ˆä¸éœ€è¦ API Keyï¼‰

#### 3.1 ä½¿ç”¨ MockWebServer

MockWebServer æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ HTTP æœåŠ¡å™¨ï¼Œç”¨äºæµ‹è¯•ï¼š

```java
private MockWebServer mockServer;

@BeforeEach
void setUp() throws IOException {
    // å¯åŠ¨ Mock æœåŠ¡å™¨
    mockServer = new MockWebServer();
    mockServer.start();
    
    // é…ç½® Settings ä½¿ç”¨ Mock æœåŠ¡å™¨çš„ URL
    settings.baseUrl = mockServer.url("/").toString();
}

@AfterEach
void tearDown() throws IOException {
    // å…³é—­æœåŠ¡å™¨
    mockServer.shutdown();
}
```

#### 3.2 æ¨¡æ‹Ÿ API å“åº”

```java
@Test
void testSuccessfulDocumentationGeneration() {
    // 1. å‡†å¤‡ Mock å“åº”ï¼ˆOpenAI æ ¼å¼ï¼‰
    String mockResponse = """
        {
            "choices": [{
                "message": {
                    "content": "/** æµ‹è¯•æ–‡æ¡£ */"
                }
            }]
        }
        """;
    
    // 2. æ·»åŠ åˆ°é˜Ÿåˆ—
    mockServer.enqueue(new MockResponse()
        .setResponseCode(200)
        .setBody(mockResponse)
        .addHeader("Content-Type", "application/json"));
    
    // 3. è°ƒç”¨ API
    String result = provider.generateDocumentation(
        "public void test() {}",
        DocumentationType.METHOD,
        "java"
    );
    
    // 4. éªŒè¯ç»“æœ
    assertThat(result).contains("æµ‹è¯•æ–‡æ¡£");
}
```

#### 3.3 éªŒè¯è¯·æ±‚å†…å®¹

```java
@Test
void testRequestValidation() throws Exception {
    mockServer.enqueue(new MockResponse()
        .setResponseCode(200)
        .setBody("{\"choices\":[{\"message\":{\"content\":\"ok\"}}]}"));
    
    provider.generateDocumentation(
        "test code", DocumentationType.METHOD, "java");
    
    // è·å–å‘é€çš„è¯·æ±‚
    RecordedRequest request = mockServer.takeRequest();
    
    // éªŒè¯ HTTP æ–¹æ³•
    assertThat(request.getMethod()).isEqualTo("POST");
    
    // éªŒè¯è·¯å¾„
    assertThat(request.getPath()).isEqualTo("/chat/completions");
    
    // éªŒè¯è¯·æ±‚å¤´
    assertThat(request.getHeader("Authorization"))
        .isEqualTo("Bearer test-api-key");
    assertThat(request.getHeader("Content-Type"))
        .contains("application/json");
    
    // éªŒè¯è¯·æ±‚ä½“
    String body = request.getBody().readUtf8();
    JSONObject json = new JSONObject(body);
    assertThat(json.getString("model")).isEqualTo("qwen-max");
    assertThat(json.getDouble("temperature")).isEqualTo(0.1);
}
```

#### 3.4 æµ‹è¯•é”™è¯¯åœºæ™¯

##### 401 æœªæˆæƒ

```java
@Test
void testUnauthorizedError() {
    mockServer.enqueue(new MockResponse()
        .setResponseCode(401)
        .setBody("{\"error\": {\"message\": \"Invalid API key\"}}"));
    
    assertThatThrownBy(() -> provider.generateDocumentation(...))
        .isInstanceOf(AIServiceException.class)
        .hasMessageContaining("Invalid API Key")
        .extracting(e -> ((AIServiceException) e).getErrorCode())
        .isEqualTo(ErrorCode.INVALID_API_KEY);
}
```

##### 429 Rate Limit

```java
@Test
void testRateLimitError() {
    mockServer.enqueue(new MockResponse()
        .setResponseCode(429)
        .setBody("{\"error\": {\"message\": \"Rate limit exceeded\"}}"));
    
    assertThatThrownBy(() -> provider.generateDocumentation(...))
        .isInstanceOf(AIServiceException.class)
        .hasMessageContaining("Rate limit");
}
```

#### 3.5 æµ‹è¯•é‡è¯•æœºåˆ¶

```java
@Test
void testRetryMechanism() {
    // ç¬¬ä¸€æ¬¡å¤±è´¥
    mockServer.enqueue(new MockResponse()
        .setResponseCode(500)
        .setBody("{\"error\": {\"message\": \"Error\"}}"));
    
    // ç¬¬äºŒæ¬¡æˆåŠŸ
    mockServer.enqueue(new MockResponse()
        .setResponseCode(200)
        .setBody("{\"choices\":[{\"message\":{\"content\":\"ok\"}}]}"));
    
    String result = provider.generateDocumentation(...);
    
    // éªŒè¯æˆåŠŸ
    assertThat(result).contains("ok");
    
    // éªŒè¯é‡è¯•äº†
    assertThat(mockServer.getRequestCount()).isEqualTo(2);
}
```

#### 3.6 æµ‹è¯•ç½‘ç»œé”™è¯¯

```java
@Test
void testNetworkError() throws IOException {
    // å…³é—­æœåŠ¡å™¨æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
    mockServer.shutdown();
    
    assertThatThrownBy(() -> provider.generateDocumentation(...))
        .isInstanceOf(AIServiceException.class)
        .hasMessageContaining("Network error")
        .extracting(e -> ((AIServiceException) e).getErrorCode())
        .isEqualTo(ErrorCode.NETWORK_ERROR);
}
```

## ğŸš€ è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./gradlew test

# åªè¿è¡Œé›†æˆæµ‹è¯•
./gradlew test --tests "*IntegrationTest"

# è¿è¡Œç‰¹å®šçš„æµ‹è¯•ç±»
./gradlew test --tests "TaskExecutorIntegrationTest"
./gradlew test --tests "AIProviderHttpIntegrationTest"

# è¿è¡Œç‰¹å®šçš„æµ‹è¯•æ–¹æ³•
./gradlew test --tests "TaskExecutorIntegrationTest.testInsertJavaDocForMethodWithoutExistingComment"
```

### åœ¨ IntelliJ IDEA ä¸­è¿è¡Œ

1. æ‰“å¼€æµ‹è¯•æ–‡ä»¶
2. å³é”®ç‚¹å‡»ç±»åæˆ–æ–¹æ³•å
3. é€‰æ‹© "Run 'TestClassName'" æˆ– "Run 'testMethodName()'"
4. æˆ–ä½¿ç”¨å¿«æ·é”® `Ctrl + Shift + F10` (Windows/Linux) æˆ– `âŒ˜ + Shift + R` (macOS)

### è°ƒè¯•æµ‹è¯•

```bash
# ä½¿ç”¨è°ƒè¯•æ¨¡å¼
./gradlew test --debug-jvm --tests "TaskExecutorIntegrationTest"
```

åœ¨ IDEA ä¸­ï¼š

1. è®¾ç½®æ–­ç‚¹
2. å³é”®é€‰æ‹© "Debug 'TestClassName'"
3. å•æ­¥è°ƒè¯•æŸ¥çœ‹ PSI æ ‘çš„å˜åŒ–

## ğŸ“– å­¦ä¹ è¦ç‚¹æ€»ç»“

### IntelliJ Platform SDK æ ¸å¿ƒæ¦‚å¿µ

#### 1. PSI (Program Structure Interface)

- **å®šä¹‰**: ä»£ç çš„è¯­ä¹‰æ ‘è¡¨ç¤º
- **å±‚æ¬¡ç»“æ„**: File â†’ Class â†’ Method/Field â†’ Statement â†’ Expression
- **è®¿é—®è§„åˆ™**: å¿…é¡»åœ¨ Read Action ä¸­è¯»å–
- **ä¿®æ”¹è§„åˆ™**: å¿…é¡»åœ¨ Write Action ä¸­ä¿®æ”¹

#### 2. Document

- **å®šä¹‰**: æ–‡ä»¶çš„æ–‡æœ¬è¡¨ç¤º
- **ç”¨é€”**: ç›´æ¥æ“ä½œæ–‡æœ¬å†…å®¹
- **åŒæ­¥**: ä¿®æ”¹åéœ€è°ƒç”¨ `commitDocument` åŒæ­¥åˆ° PSI

#### 3. VirtualFile

- **å®šä¹‰**: æ–‡ä»¶ç³»ç»Ÿçš„æŠ½è±¡è¡¨ç¤º
- **ç”¨é€”**: æ–‡ä»¶ I/O æ“ä½œ
- **å…³ç³»**: `VirtualFile` â†” `Document` â†” `PsiFile`

#### 4. Project & Module

- **Project**: IDE é¡¹ç›®çš„é¡¶å±‚å®¹å™¨
- **Module**: é¡¹ç›®çš„å­æ¨¡å—
- **Services**: é¡¹ç›®çº§åˆ«çš„æœåŠ¡ï¼ˆå¦‚ PsiManagerï¼‰

### æµ‹è¯•æœ€ä½³å®è·µ

#### 1. ä½¿ç”¨ Fixture

```java
// fixture æä¾›å®Œæ•´çš„æµ‹è¯•ç¯å¢ƒ
PsiFile file = myFixture.configureByText("Test.java", content);
myFixture.type("code");  // æ¨¡æ‹Ÿè¾“å…¥
myFixture.complete();    // æ¨¡æ‹Ÿä»£ç è¡¥å…¨
```

#### 2. å¤„ç†å¼‚æ­¥æ“ä½œ

```java
// ç­‰å¾…æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œæˆ
PsiDocumentManager.getInstance(project).commitAllDocuments();
UIUtil.dispatchAllInvocationEvents();
```

#### 3. ä½¿ç”¨ Mock

```java
// Mock å¤–éƒ¨ä¾èµ–
private void injectMock(Object target, String fieldName, Object mock) {
    Field field = target.getClass().getDeclaredField(fieldName);
    field.setAccessible(true);
    field.set(target, mock);
}
```

#### 4. éªŒè¯ç»“æœ

```java
// ä½¿ç”¨ AssertJ è¿›è¡Œæµç•…çš„æ–­è¨€
assertThat(result)
    .isNotNull()
    .isNotEmpty()
    .contains("expected text");
```

## ğŸ” å¸¸è§é—®é¢˜

### Q1: æµ‹è¯•ä¸­ PSI å…ƒç´ ä¸º null

**åŸå› **: æ²¡æœ‰åœ¨ Read Action ä¸­è®¿é—® PSI

**è§£å†³**:

```java
// âŒ é”™è¯¯
PsiMethod method = psiClass.getMethods()[0];

// âœ… æ­£ç¡®
PsiMethod method = runReadAction(() -> 
    psiClass.getMethods()[0]);
```

### Q2: Document ä¿®æ”¹å PSI æ²¡æœ‰æ›´æ–°

**åŸå› **: æ²¡æœ‰è°ƒç”¨ `commitDocument`

**è§£å†³**:

```java
Document doc = getDocument(file);
doc.insertString(0, "text");
// å¿…é¡»æäº¤
PsiDocumentManager.getInstance(project).commitDocument(doc);
```

### Q3: å¼‚æ­¥æ“ä½œæµ‹è¯•ä¸ç¨³å®š

**åŸå› **: æµ‹è¯•åœ¨æ“ä½œå®Œæˆå‰å°±è¿›è¡Œäº†éªŒè¯

**è§£å†³**:

```java
// ç­‰å¾…å¼‚æ­¥æ“ä½œ
waitForPendingWrites();
// æˆ–ä½¿ç”¨ PlatformTestUtil.dispatchAllEventsInIdeEventQueue()
```

### Q4: MockWebServer ç«¯å£å†²çª

**åŸå› **: ä¸Šä¸€ä¸ªæµ‹è¯•çš„æœåŠ¡å™¨æ²¡æœ‰æ­£ç¡®å…³é—­

**è§£å†³**:

```java
@AfterEach
void tearDown() throws IOException {
    if (mockServer != null) {
        mockServer.shutdown();
        mockServer = null;
    }
}
```

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [IntelliJ Platform SDK](https://plugins.jetbrains.com/docs/intellij/welcome.html)
- [Testing Plugins](https://plugins.jetbrains.com/docs/intellij/testing-plugins.html)
- [PSI Overview](https://plugins.jetbrains.com/docs/intellij/psi.html)
- [Documents](https://plugins.jetbrains.com/docs/intellij/documents.html)

### ç›¸å…³é¡¹ç›®

- [MockWebServer](https://github.com/square/okhttp/tree/master/mockwebserver)
- [AssertJ](https://assertj.github.io/doc/)

### æ¨èé˜…è¯»é¡ºåº

1. å…ˆçœ‹ `BasePlatformTestCase` - äº†è§£åŸºç¡€ API
2. å†çœ‹ `TaskExecutorIntegrationTest` - å­¦ä¹  PSI æ“ä½œ
3. æœ€åçœ‹ `AIProviderHttpIntegrationTest` - å­¦ä¹  HTTP æµ‹è¯•


