# âœ… é›†æˆæµ‹è¯•æ·»åŠ å®Œæˆ

## ğŸ‰ å®Œæˆæ¦‚å†µ

### ğŸ“Š æ–°å¢å†…å®¹ç»Ÿè®¡

| ç±»åˆ«    | æ•°é‡     | è¯´æ˜                         |
|-------|--------|----------------------------|
| æµ‹è¯•åŸºç±»  | 1      | BasePlatformTestCase       |
| é›†æˆæµ‹è¯•ç±» | 2      | TaskExecutor + AI Provider |
| æµ‹è¯•ç”¨ä¾‹  | 20+    | è¦†ç›–æ ¸å¿ƒé›†æˆåœºæ™¯                   |
| æµ‹è¯•æ–‡æ¡£  | 1      | è¯¦ç»†çš„å­¦ä¹ æŒ‡å—                    |
| ä»£ç è¡Œæ•°  | 1,500+ | åŒ…å«æ³¨é‡Šå’Œè¯´æ˜                    |

## ğŸ“¦ æ–°å¢æ–‡ä»¶

### 1. æµ‹è¯•åŸºç±»

**`BasePlatformTestCase.java`** - IntelliJ Platform æµ‹è¯•åŸºç±»

- âœ… æä¾›é€šç”¨çš„æµ‹è¯•å·¥å…·æ–¹æ³•
- âœ… å°è£… Read/Write Action
- âœ… å¤„ç† Document å’Œ PSI åŒæ­¥
- âœ… åˆ›å»ºæµ‹è¯•æ–‡ä»¶çš„ä¾¿æ·æ–¹æ³•
- âœ… **å±•ç¤º IntelliJ SDK æ ¸å¿ƒ API çš„ä½¿ç”¨**

**å­¦ä¹ è¦ç‚¹**:

```java
// Read Action - è¯»å– PSI
runReadAction(() -> method.getName());

// Write Action - ä¿®æ”¹ PSI
runWriteAction(() -> document.insertString(...));

// Document å’Œ PSI åŒæ­¥
commitDocument(file);
```

### 2. JavaDoc æ›¿æ¢é€»è¾‘æµ‹è¯•

**`TaskExecutorIntegrationTest.java`** - å®Œæ•´çš„ JavaDoc æ›¿æ¢æµ‹è¯•

- âœ… 6 ä¸ªæµ‹è¯•åœºæ™¯ï¼Œè¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- âœ… å±•ç¤ºå¦‚ä½•åˆ›å»ºå’Œæ“ä½œ PSI å…ƒç´ 
- âœ… å±•ç¤ºå¦‚ä½•éªŒè¯æ–‡æ¡£æ’å…¥å’Œæ›¿æ¢
- âœ… Mock AI Serviceï¼Œä¸ä¾èµ–çœŸå® API
- âœ… å¤„ç†å¼‚æ­¥æ“ä½œ

**æµ‹è¯•åœºæ™¯**:

1. âœ… ä¸ºæ²¡æœ‰ JavaDoc çš„æ–¹æ³•æ’å…¥æ³¨é‡Š
2. âœ… æ›¿æ¢å·²æœ‰çš„ JavaDoc æ³¨é‡Š
3. âœ… ä¸ºç±»æ·»åŠ  JavaDoc
4. âœ… ä¸ºå­—æ®µæ·»åŠ  JavaDoc
5. âœ… æ‰¹é‡å¤„ç†å¤šä¸ªä»»åŠ¡
6. âœ… è·³è¿‡å·²æœ‰æ–‡æ¡£çš„åŠŸèƒ½

**å­¦ä¹ è¦ç‚¹**:

```java
// åˆ›å»ºæµ‹è¯•æ–‡ä»¶
PsiJavaFile file = createJavaFile("Test.java", code);

// è·å– PSI å…ƒç´ 
PsiMethod method = runReadAction(() -> 
    file.getClasses()[0].getMethods()[0]);

// éªŒè¯ JavaDoc
Boolean hasDoc = runReadAction(() -> 
    method.getDocComment() != null);

// ç­‰å¾…å¼‚æ­¥æ“ä½œ
waitForPendingWrites();
```

### 3. AI HTTP è°ƒç”¨æµ‹è¯•

**`AIProviderHttpIntegrationTest.java`** - çœŸå® HTTP è°ƒç”¨æµ‹è¯•

- âœ… ä½¿ç”¨ MockWebServer æ¨¡æ‹Ÿ API æœåŠ¡å™¨
- âœ… 18 ä¸ªæµ‹è¯•åœºæ™¯ï¼Œè¦†ç›–å„ç§ HTTP æƒ…å†µ
- âœ… æµ‹è¯•æˆåŠŸã€å¤±è´¥ã€é‡è¯•ã€é”™è¯¯å¤„ç†
- âœ… éªŒè¯è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ã€å“åº”è§£æ
- âœ… **çœŸå®çš„ç½‘ç»œè°ƒç”¨æµ‹è¯•ï¼ˆæ—  Mockï¼‰**

**æµ‹è¯•åœºæ™¯**:

1. âœ… æˆåŠŸçš„ HTTP è¯·æ±‚å’Œå“åº”
2. âœ… 401 æœªæˆæƒé”™è¯¯
3. âœ… 429 Rate Limit é”™è¯¯
4. âœ… 500 æœåŠ¡å™¨é”™è¯¯
5. âœ… é‡è¯•æœºåˆ¶æµ‹è¯•
6. âœ… ç½‘ç»œè¿æ¥é”™è¯¯
7. âœ… å“åº”è§£æé”™è¯¯
8. âœ… ä¸åŒæ–‡æ¡£ç±»å‹çš„ç”Ÿæˆ
9. âœ… Ollama Providerï¼ˆæ—  API Keyï¼‰
10. âœ… è¯·æ±‚éªŒè¯

**å­¦ä¹ è¦ç‚¹**:

```java
// å¯åŠ¨ Mock æœåŠ¡å™¨
mockServer = new MockWebServer();
mockServer.start();

// æ¨¡æ‹Ÿå“åº”
mockServer.enqueue(new MockResponse()
    .setResponseCode(200)
    .setBody(jsonResponse)
    .addHeader("Content-Type", "application/json"));

// éªŒè¯è¯·æ±‚
RecordedRequest request = mockServer.takeRequest();
assertThat(request.getMethod()).isEqualTo("POST");
assertThat(request.getHeader("Authorization"))
    .isEqualTo("Bearer test-api-key");

// éªŒè¯è¯·æ±‚ä½“
String body = request.getBody().readUtf8();
JSONObject json = new JSONObject(body);
assertThat(json.getString("model")).isEqualTo("qwen-max");
```

### 4. æµ‹è¯•æ–‡æ¡£

**`é›†æˆæµ‹è¯•è¯´æ˜.md`** - è¯¦ç»†çš„æµ‹è¯•å­¦ä¹ æŒ‡å—

- âœ… æ¯ä¸ªæµ‹è¯•ç±»çš„è¯¦ç»†è¯´æ˜
- âœ… IntelliJ Platform SDK æ ¸å¿ƒæ¦‚å¿µè®²è§£
- âœ… ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
- âœ… å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- âœ… å‚è€ƒèµ„æ–™å’Œå­¦ä¹ è·¯å¾„

## ğŸ¯ æµ‹è¯•ç‰¹è‰²

### 1. çœŸå®çš„é›†æˆæµ‹è¯•

**ä¸æ˜¯å•å…ƒæµ‹è¯•**:

- âŒ ä¸ä½¿ç”¨è¿‡å¤šçš„ Mock
- âœ… å¯åŠ¨çœŸå®çš„ HTTP æœåŠ¡å™¨
- âœ… ä½¿ç”¨çœŸå®çš„ IntelliJ Platform ç¯å¢ƒ
- âœ… æµ‹è¯•å®é™…çš„æ–‡ä»¶æ“ä½œå’Œ PSI ä¿®æ”¹

**ä¸ºä»€ä¹ˆé‡è¦**:

- å‘ç°å•å…ƒæµ‹è¯•æ— æ³•å‘ç°çš„é—®é¢˜
- éªŒè¯ç»„ä»¶ä¹‹é—´çš„é›†æˆ
- ç¡®ä¿åœ¨çœŸå®ç¯å¢ƒä¸­æ­£å¸¸å·¥ä½œ

### 2. å®Œæ•´çš„ IntelliJ SDK å­¦ä¹ ç¤ºä¾‹

**å±•ç¤ºçš„æ ¸å¿ƒæ¦‚å¿µ**:

#### PSI (Program Structure Interface)

```java
// PSI æ ‘éå†
PsiClass[] classes = file.getClasses();
PsiMethod[] methods = classes[0].getMethods();
PsiField[] fields = classes[0].getFields();

// PSI Visitor
file.accept(new JavaRecursiveElementVisitor() {
    @Override
    public void visitMethod(PsiMethod method) {
        // å¤„ç†æ–¹æ³•
    }
});
```

#### Document æ“ä½œ

```java
// è·å– Document
Document doc = FileDocumentManager.getInstance()
    .getDocument(file.getVirtualFile());

// ä¿®æ”¹æ–‡æœ¬
doc.insertString(position, "text");

// åŒæ­¥åˆ° PSI
PsiDocumentManager.getInstance(project)
    .commitDocument(doc);
```

#### Read/Write Actions

```java
// Read Action - çº¿ç¨‹å®‰å…¨åœ°è¯»å– PSI
String name = ApplicationManager.getApplication()
    .runReadAction(() -> method.getName());

// Write Action - çº¿ç¨‹å®‰å…¨åœ°ä¿®æ”¹ PSI
WriteCommandAction.runWriteCommandAction(project, () -> {
    document.insertString(0, "text");
});
```

### 3. ç”Ÿäº§çº§åˆ«çš„æµ‹è¯•ä»£ç 

**ç‰¹ç‚¹**:

- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„æ³¨é‡Šå’Œæ–‡æ¡£
- âœ… æ¸…æ™°çš„å˜é‡å‘½å
- âœ… å®Œå–„çš„æ–­è¨€
- âœ… å¯ç»´æŠ¤å’Œå¯æ‰©å±•

**ç¤ºä¾‹**:

```java
@Test
@DisplayName("æµ‹è¯•ä¸ºæ²¡æœ‰ JavaDoc çš„æ–¹æ³•æ’å…¥æ³¨é‡Š")
void testInsertJavaDocForMethodWithoutExistingComment() {
    // Given: åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    String code = """
        public class TestClass {
            public String getUserName(int userId) {
                return "user_" + userId;
            }
        }
        """;
    PsiJavaFile file = createJavaFile("TestClass.java", code);
    
    // When: æ‰§è¡Œä»»åŠ¡
    taskExecutor.processTasks(tasks);
    waitForPendingWrites();
    
    // Then: éªŒè¯ç»“æœ
    String updatedContent = getFileText(file);
    assertThat(updatedContent).contains("/**");
}
```

## ğŸš€ è¿è¡Œæµ‹è¯•

### å¿«é€Ÿå¼€å§‹

```bash
# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
./gradlew test --tests "*IntegrationTest"

# è¿è¡Œ JavaDoc æ›¿æ¢æµ‹è¯•
./gradlew test --tests "TaskExecutorIntegrationTest"

# è¿è¡Œ HTTP è°ƒç”¨æµ‹è¯•
./gradlew test --tests "AIProviderHttpIntegrationTest"
```

### åœ¨ IDE ä¸­è¿è¡Œ

1. æ‰“å¼€æµ‹è¯•æ–‡ä»¶
2. ç‚¹å‡»ç±»åæˆ–æ–¹æ³•åæ—è¾¹çš„ç»¿è‰²è¿è¡ŒæŒ‰é’®
3. é€‰æ‹© "Run" æˆ– "Debug"
4. æŸ¥çœ‹æµ‹è¯•ç»“æœ

### æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š

```bash
# è¿è¡Œæµ‹è¯•
./gradlew test

# æ‰“å¼€æŠ¥å‘Š
open build/reports/tests/test/index.html
```

## ğŸ“– å­¦ä¹ è·¯å¾„

### åˆçº§ï¼šäº†è§£åŸºç¡€

1. **é˜…è¯» `é›†æˆæµ‹è¯•è¯´æ˜.md`**
    - äº†è§£æµ‹è¯•çš„æ•´ä½“ç»“æ„
    - å­¦ä¹  IntelliJ SDK æ ¸å¿ƒæ¦‚å¿µ

2. **è¿è¡Œæµ‹è¯•**
    - è¿è¡Œæ‰€æœ‰æµ‹è¯•çœ‹çœ‹ç»“æœ
    - å°è¯•ä¿®æ”¹æµ‹è¯•ä»£ç 

3. **é˜…è¯» `BasePlatformTestCase`**
    - ç†è§£ Read/Write Action
    - ç†è§£ Document å’Œ PSI

### ä¸­çº§ï¼šæ·±å…¥ç†è§£

4. **ç ”ç©¶ `TaskExecutorIntegrationTest`**
    - ç†è§£ PSI å…ƒç´ çš„åˆ›å»ºå’Œæ“ä½œ
    - ç†è§£ JavaDoc çš„æ’å…¥å’Œæ›¿æ¢é€»è¾‘
    - å­¦ä¹ å¼‚æ­¥æ“ä½œçš„å¤„ç†

5. **ç ”ç©¶ `AIProviderHttpIntegrationTest`**
    - ç†è§£ MockWebServer çš„ä½¿ç”¨
    - å­¦ä¹  HTTP è¯·æ±‚å’Œå“åº”çš„æµ‹è¯•
    - ç†è§£é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### é«˜çº§ï¼šå®æˆ˜åº”ç”¨

6. **ç¼–å†™è‡ªå·±çš„æµ‹è¯•**
    - ä¸ºæ–°åŠŸèƒ½æ·»åŠ æµ‹è¯•
    - æµ‹è¯•è¾¹ç•Œæ¡ä»¶
    - æµ‹è¯•é”™è¯¯åœºæ™¯

7. **ä¼˜åŒ–å’Œæ‰©å±•**
    - æ·»åŠ æ€§èƒ½æµ‹è¯•
    - æ·»åŠ æ›´å¤šé›†æˆåœºæ™¯
    - ä¼˜åŒ–æµ‹è¯•é€Ÿåº¦

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. IntelliJ Platform æ¶æ„

```
Application (å…¨å±€)
  â””â”€ Project (é¡¹ç›®)
      â””â”€ Module (æ¨¡å—)
          â””â”€ PsiFile (æ–‡ä»¶)
              â””â”€ PsiClass (ç±»)
                  â”œâ”€ PsiMethod (æ–¹æ³•)
                  â”œâ”€ PsiField (å­—æ®µ)
                  â””â”€ PsiDocComment (æ–‡æ¡£)
```

### 2. PSIã€Documentã€VirtualFile å…³ç³»

```
VirtualFile (æ–‡ä»¶ç³»ç»Ÿ)
     â†•
Document (æ–‡æœ¬ç¼–è¾‘)
     â†•
PsiFile (è¯­ä¹‰æ ‘)
```

### 3. çº¿ç¨‹æ¨¡å‹

```
EDT (Event Dispatch Thread)
  - UI æ“ä½œå¿…é¡»åœ¨æ­¤çº¿ç¨‹
  - Write Action åœ¨æ­¤çº¿ç¨‹æ‰§è¡Œ

Background Thread
  - é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
  - Read Action å¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹

Read Action
  - è¯»å– PSI æ—¶å¿…é¡»ä½¿ç”¨
  - å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æ‰§è¡Œ

Write Action
  - ä¿®æ”¹ PSI æ—¶å¿…é¡»ä½¿ç”¨
  - ç‹¬å æ‰§è¡Œï¼Œä¼šé˜»å¡å…¶ä»–æ“ä½œ
```

### 4. æµ‹è¯•ç”Ÿå‘½å‘¨æœŸ

```
@BeforeEach
  â””â”€ åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
      â””â”€ åˆå§‹åŒ– fixture
          â””â”€ åˆ›å»ºä¸´æ—¶é¡¹ç›®

æµ‹è¯•æ‰§è¡Œ
  â”œâ”€ åˆ›å»ºæµ‹è¯•æ–‡ä»¶
  â”œâ”€ æ‰§è¡Œè¢«æµ‹è¯•çš„æ“ä½œ
  â”œâ”€ ç­‰å¾…å¼‚æ­¥æ“ä½œ
  â””â”€ éªŒè¯ç»“æœ

@AfterEach
  â””â”€ æ¸…ç†èµ„æº
      â””â”€ å…³é—­æœåŠ¡å™¨
          â””â”€ åˆ é™¤ä¸´æ—¶æ–‡ä»¶
```

## ğŸ“š å‚è€ƒèµ„æ–™

### æœ¬é¡¹ç›®æ–‡æ¡£

- [é›†æˆæµ‹è¯•è¯´æ˜.md](é›†æˆæµ‹è¯•è¯´æ˜.md) - è¯¦ç»†çš„æµ‹è¯•è¯´æ˜
- [æµ‹è¯•è¯´æ˜.md](æµ‹è¯•è¯´æ˜.md) - å•å…ƒæµ‹è¯•è¯´æ˜
- [TEST_README.md](TEST_README.md) - æµ‹è¯•å¿«é€Ÿå…¥é—¨

### å®˜æ–¹æ–‡æ¡£

- [IntelliJ Platform SDK](https://plugins.jetbrains.com/docs/intellij/welcome.html)
- [Testing Plugins](https://plugins.jetbrains.com/docs/intellij/testing-plugins.html)
- [PSI Cookbook](https://plugins.jetbrains.com/docs/intellij/psi-cookbook.html)

### ç›¸å…³å·¥å…·

- [MockWebServer](https://github.com/square/okhttp/tree/master/mockwebserver)
- [AssertJ](https://assertj.github.io/doc/)
- [JUnit 5](https://junit.org/junit5/docs/current/user-guide/)

## ğŸ’¡ æœ€ä½³å®è·µ

### æµ‹è¯•ç¼–å†™

1. âœ… ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
2. âœ… æ¯ä¸ªæµ‹è¯•åªæµ‹è¯•ä¸€ä¸ªåœºæ™¯
3. âœ… ä½¿ç”¨ Given-When-Then ç»“æ„
4. âœ… æ·»åŠ è¯¦ç»†çš„æ³¨é‡Š
5. âœ… éªŒè¯å¤šä¸ªæ–¹é¢ï¼ˆä¸åªæ˜¯æˆåŠŸè·¯å¾„ï¼‰

### IntelliJ Platform æµ‹è¯•

1. âœ… æ‰€æœ‰ PSI è¯»å–åœ¨ Read Action ä¸­
2. âœ… æ‰€æœ‰ PSI ä¿®æ”¹åœ¨ Write Action ä¸­
3. âœ… Document ä¿®æ”¹åè°ƒç”¨ commitDocument
4. âœ… ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆå†éªŒè¯
5. âœ… ä½¿ç”¨ fixture åˆ›å»ºæµ‹è¯•ç¯å¢ƒ

### HTTP æµ‹è¯•

1. âœ… ä½¿ç”¨ MockWebServer è€Œä¸æ˜¯çœŸå® API
2. âœ… æµ‹è¯•æˆåŠŸå’Œå¤±è´¥åœºæ™¯
3. âœ… éªŒè¯è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“
4. âœ… æµ‹è¯•é‡è¯•å’Œé”™è¯¯å¤„ç†
5. âœ… åœ¨ tearDown ä¸­å…³é—­æœåŠ¡å™¨

