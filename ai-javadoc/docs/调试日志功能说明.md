# 调试日志功能说明

## 📋 概述

为了方便开发者调试和排查问题，插件新增了详细的调试日志功能。当启用**详细日志**选项后，插件会记录与 AI 服务交互的所有关键信息。

---

## 🎯 启用方式

### 在设置面板中启用

1. 打开 **Preferences** → **Tools** → **AI Javadoc**
2. 滚动到 **高级配置** 部分
3. 勾选 **"启用详细日志"** 选项
4. 点击 **"Apply"** 或 **"OK"**

### 配置项

- **字段名**: `verboseLogging`
- **类型**: `boolean`
- **默认值**: `false`（关闭）
- **位置**: `SettingsState.java`

---

## 📝 日志内容

### 1. 文档生成开始

**触发时机**：每次开始生成文档时

**记录内容**：

```
=== Generate Documentation ===
Type: METHOD
Language: java
Code Length: 156 characters
Code Preview: public void calculateTotal() {...
Built Prompt Length: 789 characters
```

**字段说明**：

- `Type`: 文档类型（CLASS, METHOD, FIELD, TEST_METHOD）
- `Language`: 编程语言
- `Code Length`: 代码长度
- `Code Preview`: 代码预览（前 300 字符）
- `Built Prompt Length`: 构建的提示词长度

---

### 2. 请求尝试

**触发时机**：每次尝试发送请求时

**记录内容**：

```
Attempt 1/3 to generate documentation
```

---

### 3. AI 请求详情

**触发时机**：发送 HTTP 请求前

**记录内容**：

```
=== AI Request ===
URL: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions
Model: qwen-max
Temperature: 0.1
Max Tokens: 1000
Headers: [Content-Type:"application/json", Authorization:"Bearer ***masked***"]
Request Body: {"model":"qwen-max","messages":[{"role":"user","content":"..."}],"temperature":0.1,"max_tokens":1000}
Prompt Length: 789 characters
Prompt (first 500 chars): 你是一个专业的 Java 开发工程师...
```

**字段说明**：

- `URL`: 请求的完整 URL
- `Model`: 使用的模型名称
- `Temperature`: 温度参数
- `Max Tokens`: 最大 token 数
- `Headers`: 请求头（**API Key 已脱敏**）
- `Request Body`: 请求体（截断到 1000 字符）
- `Prompt Length`: 完整 Prompt 长度
- `Prompt (first 500 chars)`: Prompt 前 500 字符

**安全特性**：

- ✅ API Key 自动脱敏为 `***masked***`
- ✅ 长文本自动截断
- ✅ 显示原始长度信息

---

### 4. AI 响应详情

**触发时机**：收到 HTTP 响应后

**记录内容**：

```
=== AI Response ===
Status Code: 200 OK
Response Body: {"id":"chatcmpl-xxx","object":"chat.completion","created":1234567890,"model":"qwen-max","choices":[{"index":0,"message":{"role":"assistant","content":"/**\n * 计算总金额\n */"},"finish_reason":"stop"}],"usage":{"prompt_tokens":123,"completion_tokens":45,"total_tokens":168}}
Parsed Result Length: 28 characters
Parsed Result: /**
 * 计算总金额
 */
```

**字段说明**：

- `Status Code`: HTTP 状态码
- `Response Body`: 完整响应体（截断到 2000 字符）
- `Parsed Result Length`: 解析后的结果长度
- `Parsed Result`: 解析后的 JavaDoc 注释（截断到 1000 字符）

---

### 5. 成功完成

**触发时机**：文档生成成功

**记录内容**：

```
Successfully generated documentation on attempt 1
```

---

### 6. 错误日志

#### HTTP 客户端错误（4xx）

**触发时机**：收到 4xx 状态码

**记录内容**：

```
HTTP Client Error: Status=401 UNAUTHORIZED, Body={"error":{"message":"Invalid API key","type":"invalid_request_error"}}
```

**常见错误**：

- `401`: API Key 无效
- `403`: 权限不足
- `429`: 请求频率超限

---

#### HTTP 服务器错误（5xx）

**触发时机**：收到 5xx 状态码

**记录内容**：

```
HTTP Server Error: Status=500 INTERNAL_SERVER_ERROR, Body={"error":{"message":"Internal server error"}}
```

---

#### 网络错误

**触发时机**：网络连接失败

**记录内容**：

```
Network Error: Connection refused: connect
```

**常见原因**：

- Base URL 配置错误
- 网络不可达
- 代理配置问题

---

#### 重试日志

**触发时机**：请求失败但可以重试

**记录内容**：

```
Request failed, retrying in 5000ms (attempt 1/3): Rate limit exceeded
```

**字段说明**：

- `retrying in 5000ms`: 等待时间（指数退避）
- `attempt 1/3`: 当前尝试次数 / 最大重试次数
- `Rate limit exceeded`: 错误原因

---

#### 最终失败

**触发时机**：所有重试都失败

**记录内容**：

```
Generation failed after 3 attempts: Rate limit exceeded
```

---

## 📊 日志级别

### DEBUG

**用途**：详细的调试信息

**内容**：

- 请求/响应详情
- Prompt 内容
- 代码预览
- 解析结果

**启用条件**：

- ✅ `verboseLogging = true`
- ✅ 日志级别设置为 DEBUG

---

### WARN

**用途**：警告信息

**内容**：

- 重试通知
- 删除旧注释失败

**启用条件**：

- ✅ 总是启用（不受 `verboseLogging` 控制）

---

### ERROR

**用途**：错误信息

**内容**：

- HTTP 错误
- 网络错误
- 解析失败
- 最终失败

**启用条件**：

- ✅ 总是启用（不受 `verboseLogging` 控制）

---

## 🔧 配置 IDEA 日志级别

### 方法 1：通过配置文件

1. 找到 `log4j.properties` 或 `log4j2.xml`
2. 添加或修改：
   ```properties
   log4j.logger.dev.dong4j.zeka.stack.idea.plugin=DEBUG
   ```

### 方法 2：通过 IDEA 设置

1. 打开 **Help** → **Diagnostic Tools** → **Debug Log Settings**
2. 添加：
   ```
   dev.dong4j.zeka.stack.idea.plugin
   ```
3. 点击 **OK**

### 查看日志

1. 打开 **Help** → **Show Log in Finder/Explorer**
2. 查看 `idea.log` 文件

---

## 💡 使用场景

### 1. 调试 API 连接问题

**场景**：配置完成后无法连接 AI 服务

**操作**：

1. 启用详细日志
2. 尝试生成 JavaDoc
3. 查看日志中的 URL、Headers、错误信息

**示例日志**：

```
URL: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions
HTTP Client Error: Status=401 UNAUTHORIZED
```

**诊断**：API Key 配置错误

---

### 2. 分析生成质量问题

**场景**：生成的 JavaDoc 质量不理想

**操作**：

1. 启用详细日志
2. 生成 JavaDoc
3. 检查日志中的：
    - Prompt 内容
    - 传入的代码
    - AI 返回的结果

**示例日志**：

```
Code Preview: public void method() {...
Prompt (first 500 chars): 你是一个专业的 Java 开发工程师...
Parsed Result: /** 方法说明 */
```

**诊断**：可以根据 Prompt 和结果调整 Prompt 模板

---

### 3. 排查超时问题

**场景**：请求经常超时

**操作**：

1. 启用详细日志
2. 观察日志
3. 检查：
    - 请求发送时间
    - 响应接收时间
    - 重试次数

**示例日志**：

```
Attempt 1/3 to generate documentation
Network Error: Read timed out
Request failed, retrying in 5000ms (attempt 1/3)
```

**诊断**：需要增加超时时间或检查网络

---

### 4. 调试 Prompt 模板

**场景**：自定义 Prompt 模板后效果不理想

**操作**：

1. 启用详细日志
2. 生成 JavaDoc
3. 查看实际发送的 Prompt
4. 对比预期和实际

**示例日志**：

```
Built Prompt Length: 789 characters
Prompt (first 500 chars): 你是一个专业的 Java 开发工程师，请为以下代码生成完整的 JavaDoc 注释（中文）...
```

**诊断**：检查 Prompt 格式、占位符替换是否正确

---

## ⚠️ 注意事项

### 1. 性能影响

**影响**：

- ❌ 日志记录会略微影响性能
- ❌ 大量日志可能占用磁盘空间

**建议**：

- ✅ 仅在调试时启用
- ✅ 调试完成后关闭
- ✅ 定期清理日志文件

---

### 2. 敏感信息保护

**已保护**：

- ✅ API Key 自动脱敏
- ✅ 只记录请求头的键名，不记录完整值

**仍需注意**：

- ⚠️ Prompt 中可能包含业务代码
- ⚠️ 日志文件可能包含敏感信息
- ⚠️ 不要将日志文件分享给他人

---

### 3. 日志文件大小

**问题**：详细日志会快速增长

**解决方案**：

- 定期清理旧日志
- 使用日志轮转
- 只在需要时启用

---

## 📝 日志示例

### 完整的成功流程

```
=== Generate Documentation ===
Type: METHOD
Language: java
Code Length: 156 characters
Code Preview: public void calculateTotal() {
    return items.stream()
        .map(Item::getPrice)
        .reduce(0.0, Double::sum);
}
Built Prompt Length: 789 characters

Attempt 1/3 to generate documentation

=== AI Request ===
URL: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions
Model: qwen-max
Temperature: 0.1
Max Tokens: 1000
Headers: [Content-Type:"application/json", Authorization:"Bearer ***masked***"]
Request Body: {"model":"qwen-max","messages":[{"role":"user","content":"你是一个专业的 Java 开发工程师..."}],"temperature":0.1,"max_tokens":1000}
Prompt Length: 789 characters
Prompt (first 500 chars): 你是一个专业的 Java 开发工程师，请为以下代码生成完整的 JavaDoc 注释（中文）。

要求：
1. 必须包含完整的 JavaDoc 格式，包括开始标记 /** 和结束标记 */
2. 使用中文编写注释内容
...

=== AI Response ===
Status Code: 200 OK
Response Body: {"id":"chatcmpl-xxx","object":"chat.completion","created":1234567890,"model":"qwen-max","choices":[{"index":0,"message":{"role":"assistant","content":"/**\n * 计算所有商品的总金额\n * \n * @return 总金额\n */"},"finish_reason":"stop"}],"usage":{"prompt_tokens":123,"completion_tokens":45,"total_tokens":168}}
Parsed Result Length: 65 characters
Parsed Result: /**
 * 计算所有商品的总金额
 * 
 * @return 总金额
 */

Successfully generated documentation on attempt 1
```

---

### 重试后成功的流程

```
=== Generate Documentation ===
Type: METHOD
Language: java
Code Length: 85 characters
Code Preview: public void save() { ... }
Built Prompt Length: 456 characters

Attempt 1/3 to generate documentation

=== AI Request ===
...

HTTP Client Error: Status=429 TOO_MANY_REQUESTS, Body={"error":{"message":"Rate limit exceeded"}}

Request failed, retrying in 5000ms (attempt 1/3): Rate limit exceeded

Attempt 2/3 to generate documentation

=== AI Request ===
...

=== AI Response ===
Status Code: 200 OK
...

Successfully generated documentation on attempt 2
```

---

## 🔗 相关文件

**实现文件**：

- `OpenAICompatibleProvider.java` - 主要日志逻辑

**关键方法**：

- `generateDocumentation()` - 生成流程日志
- `sendRequest()` - 请求/响应日志
- `maskSensitiveHeaders()` - API Key 脱敏
- `truncateForLog()` - 长文本截断
