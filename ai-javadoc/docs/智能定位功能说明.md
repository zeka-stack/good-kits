# 智能定位功能说明

## 📋 功能概览

新增了**智能定位**功能，所有入口（快捷键、右键菜单、Generate 菜单、Intention Action）都能根据光标位置自动识别需要生成文档的代码元素。

---

## 🎯 智能定位逻辑

### 定位优先级

1. **方法 (PsiMethod)** - 最高优先级
2. **字段 (PsiField)** - 中等优先级
3. **类 (PsiClass)** - 较低优先级
4. **文件 (PsiFile)** - 默认

### 具体行为

| 光标位置       | 识别结果    | 生成范围      |
|------------|---------|-----------|
| 方法内部或方法签名上 | 方法      | 只为该方法生成   |
| 字段声明行      | 字段      | 只为该字段生成   |
| 类名或类声明行    | 类（仅类自身） | 只为类生成     |
| 类内部（非特定成员） | 类（整个类）  | 为类及所有成员生成 |
| 其他位置       | 文件      | 为整个文件生成   |

---

## 🚀 使用示例

### 示例 1：为单个方法生成

```java
public class Calculator {
    
    public int add(int a, int b) {  // 光标在这一行
        return a + b;
    }
    
    public int subtract(int a, int b) {
        return a - b;
    }
}
```

**操作**：将光标放在 `add` 方法上，按 `Cmd+Shift+D`

**结果**：只为 `add` 方法生成 JavaDoc，`subtract` 方法不受影响

---

### 示例 2：为单个字段生成

```java
public class User {
    
    private String name;  // 光标在这一行
    
    private int age;
    
    public String getName() {
        return name;
    }
}
```

**操作**：将光标放在 `name` 字段上，按 `Cmd+Shift+D`

**结果**：只为 `name` 字段生成 JavaDoc

---

### 示例 3：为整个类生成

```java
public class Product {  // 光标在类名上
    
    private String name;
    
    private double price;
    
    public String getName() {
        return name;
    }
}
```

**操作**：将光标放在类名 `Product` 上，按 `Cmd+Shift+D`

**结果**：为类、所有字段和所有方法生成 JavaDoc

---

### 示例 4：类内部空白处

```java
public class Order {
    // 光标在这一行（类内部，但不在任何成员上）
    
    private String orderId;
    
    public String getOrderId() {
        return orderId;
    }
}
```

**操作**：将光标放在类内部空白处，按 `Cmd+Shift+D`

**结果**：为整个类及所有成员生成 JavaDoc

---

## 🔌 所有入口

### 1. 快捷键 (Ctrl+Shift+D / Cmd+Shift+D)

**文件**：`Action.java`

**智能定位**：✅ 已实现

```java
// 光标在方法上 → 只为该方法生成
// 光标在字段上 → 只为该字段生成
// 光标在类声明上 → 只为该类生成
// 光标在类内部 → 为整个类及所有成员生成
// 其他位置 → 为整个文件生成
```

---

### 2. 编辑器右键菜单

**文件**：`GenerateJavaDocForFileAction.java`

**菜单位置**：编辑器右键 → Generate JavaDoc with AI

**智能定位**：✅ 已实现

**行为**：与快捷键相同

---

### 3. Generate 菜单 (Cmd+N / Alt+Insert)

**文件**：`GenerateJavaDocGenerateAction.java`

**菜单位置**：Cmd+N (Mac) 或 Alt+Insert (Win/Linux) → JavaDoc with AI

**智能定位**：✅ 已实现

**行为**：与快捷键相同

---

### 4. Intention Action (Option+Enter / Alt+Enter)

**文件**：`GenerateJavaDocIntentionAction.java`

**菜单位置**：Option+Enter (Mac) 或 Alt+Enter (Win/Linux) → Generate JavaDoc with AI

**智能定位**：✅ 已实现

**特殊行为**：

- 只在可以生成 JavaDoc 的元素上显示
- 自动过滤已有 JavaDoc 的元素
- 不在文件级别显示（避免重复）

**显示条件**：

1. 光标在类、方法或字段上
2. 该元素还没有 JavaDoc 注释
3. 当前文件是 Java 文件

---

### 5. 文件/目录右键菜单

**文件**：`GenerateJavaDocForSelectionAction.java`

**菜单位置**：项目视图中，右键文件/目录 → Generate JavaDoc with AI

**智能定位**：❌ 不适用（批量处理）

**行为**：为选中的所有 Java 文件生成文档

---

## 🛠️ 技术实现

### 核心组件

#### 1. PsiElementLocator

**位置**：`dev.dong4j.zeka.stack.idea.plugin.util.PsiElementLocator`

**职责**：智能定位 PSI 元素

**核心方法**：

```java
// 根据编辑器光标位置定位元素
public static LocateResult locateElement(Editor editor, PsiFile psiFile)

// 根据偏移量定位元素
public static LocateResult locateElementAtOffset(PsiFile psiFile, int offset)

// 检查是否已有 JavaDoc
public static boolean hasJavaDoc(PsiElement element)

// 获取元素描述
public static String getElementDescription(PsiElement element)
```

**定位流程**：

```
1. 获取光标位置的 PSI 元素
   ↓
2. 向上遍历 PSI 树
   ↓
3. 优先查找方法 (PsiMethod)
   ↓
4. 如果没有，查找字段 (PsiField)
   ↓
5. 如果没有，查找类 (PsiClass)
   ↓
6. 判断是否在类声明行
   - 是 → 返回类（仅类自身）
   - 否 → 返回类（整个类）
   ↓
7. 默认返回文件 (PsiFile)
```

---

#### 2. TaskCollector 增强

**位置**：`dev.dong4j.zeka.stack.idea.plugin.task.TaskCollector`

**新增方法**：

```java
// 从单个元素收集任务
public List<DocumentationTask> collectFromElement(PsiElement element)

// 从类收集任务（包括所有成员）
private void collectFromClass(PsiClass psiClass, List<DocumentationTask> tasks)
```

**收集逻辑**：

```java
if (element instanceof PsiMethod) {
    // 只收集该方法
} else if (element instanceof PsiField) {
    // 只收集该字段
} else if (element instanceof PsiClass) {
    // 收集类及所有成员
} else if (element instanceof PsiFile) {
    // 收集整个文件
}
```

---

#### 3. 所有 Action 的更新

**共同模式**：

```java
@Override
public void actionPerformed(@NotNull AnActionEvent e) {
    // 1. 获取编辑器和文件
    Editor editor = e.getData(CommonDataKeys.EDITOR);
    PsiFile psiFile = e.getData(CommonDataKeys.PSI_FILE);
    
    // 2. 智能定位
    PsiElementLocator.LocateResult locateResult = 
        PsiElementLocator.locateElement(editor, psiFile);
    
    // 3. 根据定位结果收集任务
    TaskCollector collector = new TaskCollector(project);
    List<DocumentationTask> tasks = collector.collectFromElement(locateResult.getElement());
    
    // 4. 执行任务
    TaskExecutor executor = new TaskExecutor(project, indicator);
    executor.processTasks(tasks);
}
```

---

## 📊 用户体验提升

### Before（v1.0）

| 场景       | v1.0 行为 | 用户痛点           |
|----------|---------|----------------|
| 想为单个方法生成 | 为整个文件生成 | ❌ 生成太多不需要的注释   |
| 想为单个字段生成 | 为整个文件生成 | ❌ 浪费时间和 API 调用 |
| 想为一个类生成  | 为整个文件生成 | ❌ 多个类时不够精确     |

### After（v2.0）

| 场景       | v2.0 行为 | 用户收益      |
|----------|---------|-----------|
| 想为单个方法生成 | 只为该方法生成 | ✅ 精确控制    |
| 想为单个字段生成 | 只为该字段生成 | ✅ 节省时间和成本 |
| 想为一个类生成  | 只为该类生成  | ✅ 精确且高效   |
| 想为整个文件生成 | 光标放文件顶部 | ✅ 仍然支持    |

---

## 🎨 UI/UX 改进

### 进度提示

```
旧版本：生成 JavaDoc
新版本：生成 JavaDoc - 方法: calculateSum()
```

**好处**：用户清楚知道正在为哪个元素生成

---

### 完成提示

```
旧版本：
文档生成完成！
成功: 5
失败: 0
跳过: 0

新版本：
方法: calculateSum() 文档生成完成！
成功: 1
失败: 0
跳过: 0
```

**好处**：更清晰的反馈

---

### Intention Action

**显示条件优化**：

- ❌ 已有 JavaDoc → 不显示
- ❌ 文件级别 → 不显示（避免与其他入口重复）
- ✅ 方法、字段、类 → 显示

**单个元素优化**：

- 如果只有一个任务且成功，不显示统计弹窗
- 直接完成，用户体验更流畅

---

## 🧪 测试场景

### 测试用例

#### 1. 方法定位测试

```java
public class Test {
    // 光标在方法签名任意位置
    public void testMethod() {  // ← 这里
        int a = 1;
        int b = 2;  // 或这里
    }
}
```

**预期**：只为 `testMethod` 生成 JavaDoc

---

#### 2. 字段定位测试

```java
public class Test {
    private String field1;  // ← 光标这里
    private int field2;
}
```

**预期**：只为 `field1` 生成 JavaDoc

---

#### 3. 类定位测试（类名）

```java
public class Test {  // ← 光标在类名上
    private String field;
    public void method() {}
}
```

**预期**：为类、字段、方法都生成 JavaDoc

---

#### 4. 类定位测试（内部）

```java
public class Test {
    // 光标在这里（类内部空白处）
    private String field;
    public void method() {}
}
```

**预期**：为类、字段、方法都生成 JavaDoc

---

#### 5. 多个类测试

```java
public class Class1 {
    public void method1() {}  // ← 光标这里
}

class Class2 {
    public void method2() {}
}
```

**预期**：只为 `method1` 生成 JavaDoc，`Class2` 和 `method2` 不受影响

---

#### 6. 嵌套类测试

```java
public class Outer {
    public void outerMethod() {}
    
    class Inner {  // ← 光标在这里
        public void innerMethod() {}
    }
}
```

**预期**：为 `Inner` 类及 `innerMethod` 生成 JavaDoc

---

#### 7. 已有 JavaDoc 测试

```java
public class Test {
    /**
     * 已有注释
     */
    public void method1() {}  // ← 光标这里
    
    public void method2() {}
}
```

**预期**：

- 快捷键/右键：提示"当前元素已有文档"
- Intention Action：不显示

---

## 📝 配置项

智能定位功能会遵循设置面板中的配置：

```java
// SettingsState.java
public boolean generateForClass = true;    // 是否为类生成
public boolean generateForMethod = true;   // 是否为方法生成
public boolean generateForField = true;    // 是否为字段生成
public boolean skipExisting = true;        // 跳过已有文档
```

**行为**：

- 如果 `skipExisting = true`，已有 JavaDoc 的元素会被跳过
- 如果 `generateForMethod = false`，即使定位到方法也不会生成

---

## 🔄 与原有功能的兼容性

### 文件/目录批量处理

**不受影响**：`GenerateJavaDocForSelectionAction` 仍然为选中的所有文件批量生成

---

### 向后兼容

**Legacy 快捷键**：`Action.java` 已更新为使用智能定位，但保留向后兼容

---

## ✅ 实现完成清单

- [x] ✅ 创建 `PsiElementLocator` 工具类
- [x] ✅ 增强 `TaskCollector.collectFromElement()`
- [x] ✅ 更新 `Action.java`（快捷键）
- [x] ✅ 更新 `GenerateJavaDocForFileAction.java`（编辑器右键）
- [x] ✅ 更新 `GenerateJavaDocGenerateAction.java`（Generate 菜单）
- [x] ✅ 创建 `GenerateJavaDocIntentionAction.java`（Intention Action）
- [x] ✅ 在 `plugin.xml` 中注册 Intention Action
- [x] ✅ 创建 Intention Action 描述文件
- [x] ✅ 所有入口统一使用智能定位逻辑

