# 异常处理优化说明

## 优化目标

将插件中直接抛出的异常改为使用友好的用户界面提示，避免在 IDEA 中直接显示错误对话框，提升用户体验。

## 优化原则

1. **设置页面**：使用 `MessageDialog`（`JOptionPane`）显示错误，因为用户正在主动进行配置操作
2. **编辑页面**：使用 `NotificationUtil` 显示通知，避免打断用户的编辑流程
3. **统一错误消息**：将技术性异常信息转换为用户友好的提示文本

## 优化内容

### 1. AICompatibleProvider.java

**优化点：**

- 将 `buildHeaders()` 方法中的 `IllegalStateException` 改为 `AIServiceException`
- 使用统一的异常类型，便于上层统一处理
- 添加明确的错误码 `ErrorCode.CONFIGURATION_ERROR`

**修改：**

```java
// 之前：抛出 IllegalStateException
throw new IllegalStateException("API Key is required but not configured");

// 之后：抛出 AIServiceException
throw new AIServiceException("API Key is required but not configured",
                            AIServiceException.ErrorCode.CONFIGURATION_ERROR);
```

### 2. AIServiceFactory.java

**优化点：**

- 将 `createProvider()` 方法的异常从 `IllegalArgumentException` 和 `RuntimeException` 统一改为 `AIServiceException`
- 提供中文友好的错误消息

**修改：**

```java
// 之前：抛出 IllegalArgumentException 和 RuntimeException
throw new IllegalArgumentException("Unsupported AI provider: " + providerId);
throw new RuntimeException("Failed to create AI provider: " + providerId, e);

// 之后：统一抛出 AIServiceException
throw new AIServiceException(
    "不支持的 AI 提供商: " + providerId + "。当前支持的提供商：qianwen, ollama",
    AIServiceException.ErrorCode.CONFIGURATION_ERROR
);
throw new AIServiceException(
    "创建 AI 提供商失败: " + providerId + "。请检查配置是否正确。",
    AIServiceException.ErrorCode.CONFIGURATION_ERROR,
    e
);
```

### 3. TaskExecutor.java

**优化点：**

- 在 `processTask()` 方法中添加 `AIServiceException` 专门的异常处理分支
- 实现 `getAIServiceErrorMessage()` 方法，将异常转换为友好的错误消息
- 使用 `NotificationUtil.notifyErrorMessage()` 显示错误通知（仅第一次失败时）
- 构造函数声明可能抛出 `AIServiceException`

**修改：**

```java
// 添加专门的 AIServiceException 处理
catch (AIServiceException e) {
    String errorMessage = getAIServiceErrorMessage(e);
    log.info("AI 服务调用失败: {} - {}", task, errorMessage, e);
    
    // 只在第一次失败时显示通知，避免过多通知
    if (failedCount.get() == 1) {
        NotificationUtil.notifyErrorMessage(project, errorMessage);
    }
}
```

**错误消息映射：**

- `INVALID_API_KEY` → "API Key 无效，请在设置中检查并更新 API Key"
- `RATE_LIMIT` → "请求频率过高，请稍后再试"
- `SERVICE_UNAVAILABLE` → "AI 服务暂时不可用，请稍后再试"
- `NETWORK_ERROR` → "网络连接失败，请检查网络连接或服务器地址"
- `CONFIGURATION_ERROR` → "配置错误: {详细消息}"
- `INVALID_RESPONSE` → "AI 服务返回的数据格式错误"

### 4. JavaDocSettingsPanel.java

**优化点：**

- 在 `testConnection()` 方法中改进异常处理
- 添加 `getFriendlyErrorMessage()` 方法，转换异常为友好消息
- 确保所有错误都通过 `JOptionPane.showMessageDialog()` 显示

**修改：**

```java
// 配置创建阶段的异常处理
try {
    testSettings = getSettings();
    provider = AIServiceFactory.createProvider(testSettings);
} catch (AIServiceException e) {
    // 使用 MessageDialog 显示友好的错误消息
    String errorMessage = getFriendlyErrorMessage(e);
    JOptionPane.showMessageDialog(
        mainPanel,
        errorMessage,
        JavaDocBundle.message("settings.error.title"),
        JOptionPane.ERROR_MESSAGE
    );
    return;
}

// 测试连接阶段的异常处理
catch (Exception e) {
    String errorMessage = e instanceof AIServiceException
        ? getFriendlyErrorMessage((AIServiceException) e)
        : JavaDocBundle.message("settings.test.connection.error", e.getMessage());
    
    JOptionPane.showMessageDialog(
        mainPanel,
        errorMessage,
        JavaDocBundle.message("settings.test.result.title"),
        JOptionPane.ERROR_MESSAGE
    );
}
```

### 5. 所有 Action 类

**优化的 Action 类：**

- `GenerateJavaDocForSelectionAction.java`
- `GenerateJavaDocIntentionAction.java`
- `GenerateJavaDocShortcutAction.java`
- `GenerateJavaDocForFileAction.java`
- `GenerateJavaDocGenerateAction.java`

**优化点：**

- 在创建 `TaskExecutor` 时捕获 `AIServiceException`
- 使用 `NotificationUtil.notifyErrorMessage()` 显示错误通知
- 通过 `ApplicationManager.getApplication().invokeLater()` 确保在 EDT 线程中显示通知

**修改：**

```java
new Task.Backgroundable(project, JavaDocBundle.message("progress.generating"), true) {
    @Override
    public void run(@NotNull ProgressIndicator indicator) {
        try {
            TaskExecutor executor = new TaskExecutor(project, indicator);
            executor.processTasks(tasks);
            // ... 处理结果
        } catch (AIServiceException e) {
            log.info("创建任务执行器失败", e);
            ApplicationManager.getApplication().invokeLater(() -> {
                String errorMessage = "AI 服务配置错误: " + e.getMessage();
                NotificationUtil.notifyErrorMessage(project, errorMessage);
            });
        }
    }
}
```

## 用户体验改进

### 1. 设置页面的体验

**场景：** 用户在设置页面点击"测试连接"按钮

**优化前：**

- 直接抛出异常，显示技术性的错误堆栈
- 用户不知道如何修复问题

**优化后：**

- 显示友好的 MessageDialog
- 明确告知问题原因（如"API Key 无效"）
- 提供解决建议（如"请检查并更新 API Key"）

### 2. 编辑页面的体验

**场景：** 用户在编辑代码时使用快捷键或菜单生成文档

**优化前：**

- 异常会打断编辑流程
- 可能显示模态对话框，阻塞用户操作

**优化后：**

- 使用右下角的通知气泡显示错误
- 不阻塞用户的编辑操作
- 通知会自动消失或可手动关闭
- 只在第一次失败时显示通知，避免多次通知骚扰用户

### 3. 批量操作的体验

**场景：** 用户为多个文件/方法批量生成文档

**优化前：**

- 第一个任务失败就中断整个流程
- 用户不知道有多少任务成功/失败

**优化后：**

- 单个任务失败不影响其他任务
- 只在第一次失败时显示错误通知
- 最终显示完整的统计信息（成功/失败/跳过）
- 用户可以根据统计信息决定是否需要修复配置

## 错误消息国际化

所有错误消息都使用中文，符合目标用户群体的语言习惯。主要错误类型的消息如下：

| 错误类型       | 友好消息                          |
|------------|-------------------------------|
| API Key 无效 | API Key 无效，请在设置中检查并更新 API Key |
| 请求频率限制     | 请求频率过高，请稍后再试                  |
| 服务不可用      | AI 服务暂时不可用，请稍后再试              |
| 网络错误       | 网络连接失败，请检查网络连接或服务器地址          |
| 配置错误       | 配置错误: {具体错误信息}                |
| 响应格式错误     | AI 服务返回的数据格式错误                |

## 技术要点

1. **统一异常类型**：使用 `AIServiceException` 作为统一的业务异常类型
2. **错误码机制**：通过 `ErrorCode` 枚举区分不同的错误类型
3. **分层处理**：底层抛出统一异常，上层根据场景选择合适的提示方式
4. **线程安全**：使用 `ApplicationManager.getApplication().invokeLater()` 确保 UI 操作在正确的线程中执行
5. **避免过度通知**：批量操作时只显示第一次失败的通知

## 测试建议

1. **设置页面测试**：
    - 测试空 API Key
    - 测试无效的 Base URL
    - 测试网络连接失败
    - 验证错误消息显示正确

2. **编辑页面测试**：
    - 在未配置 API Key 的情况下生成文档
    - 在网络断开的情况下生成文档
    - 批量生成时测试错误处理
    - 验证通知显示正确且不阻塞编辑

3. **批量操作测试**：
    - 测试部分任务失败的情况
    - 验证统计信息显示正确
    - 验证不会显示过多的错误通知
