# 配置验证功能实现说明

## 概述

实现了一个完整的 AI 提供商配置验证机制，确保只有通过测试验证的配置才能用于生成文档。

## 需求背景

用户反馈：即使没有配置 API Key，只要选择了内置提供商，系统就不会返回 null。但实际上，未配置或配置错误的提供商是无法正常工作的。

**解决方案**：要求用户在设置页面点击"测试连接"按钮，只有测试成功后配置才算可用。

## 核心实现

### 1. SettingsState 添加验证状态字段

**文件**: `src/main/java/com/github/intellijjavadocai/settings/SettingsState.java`

添加了 `configurationVerified` 字段来标记配置是否已通过验证：

```java
/**
 * 配置是否已通过测试验证
 */
public boolean configurationVerified = false;
```

**特性**：

- 默认值为 `false`（未验证）
- 测试成功时设置为 `true`
- 修改关键配置时自动重置为 `false`
- 持久化保存，重启 IDE 后保持状态

### 2. AIServiceFactory 验证检查

**文件**: `src/main/java/com/github/intellijjavadocai/ai/AIServiceFactory.java`

#### 2.1 修改 createProvider 方法

在创建提供商前检查配置是否已验证：

```java
public static AIServiceProvider createProvider(@NotNull SettingsState settings) {
    // 检查配置是否已通过验证
    if (!settings.configurationVerified) {
        String error = JavaDocBundle.message("error.configuration.not.verified");
        Logger.getInstance(AIServiceFactory.class).warn(error);
        return null;
    }
    // ... 创建提供商
}
```

#### 2.2 添加可用提供商接口

为未来的多提供商并行处理提供支持：

```java
/**
 * 获取所有可用的服务提供商实例
 */
@NotNull
public static List<AIServiceProvider> getAvailableProviders() {
    List<AIServiceProvider> providers = new ArrayList<>();
    SettingsState settings = SettingsState.getInstance();
    AIServiceProvider provider = createProvider(settings);
    if (provider != null) {
        providers.add(provider);
    }
    return providers;
}

/**
 * 检查是否有可用的服务提供商
 */
public static boolean hasAvailableProvider() {
    SettingsState settings = SettingsState.getInstance();
    return settings.configurationVerified 
        && settings.aiProvider != null 
        && isProviderSupported(settings.aiProvider);
}

/**
 * 获取可用提供商的数量
 */
public static int getAvailableProviderCount() {
    return hasAvailableProvider() ? 1 : 0;
}
```

**未来扩展**：

- 支持多个提供商配置的存储
- 支持并行调用多个提供商
- 支持负载均衡和故障转移

### 3. JavaDocSettingsPanel 验证状态管理

**文件**: `src/main/java/com/github/intellijjavadocai/settings/ui/JavaDocSettingsPanel.java`

#### 3.1 验证状态跟踪

添加字段跟踪当前验证状态：

```java
// 验证状态标记
private boolean configurationVerified = false;
```

#### 3.2 测试连接功能增强

```java
private void testConnection() {
    SettingsState testSettings = getSettings();
    // 临时允许创建未验证的提供商用于测试
    testSettings.configurationVerified = true;
    AIServiceProvider provider = AIServiceFactory.createProvider(testSettings);
    
    // 在后台线程测试
    new Thread(() -> {
        try {
            boolean success = provider.validateConfiguration();
            SwingUtilities.invokeLater(() -> {
                if (success) {
                    // 测试成功，标记配置为已验证
                    markConfigurationAsVerified();
                } else {
                    // 测试失败，清除验证状态
                    markConfigurationAsUnverified();
                }
            });
        } catch (Exception e) {
            // 测试异常，清除验证状态
            markConfigurationAsUnverified();
        }
    }).start();
}
```

#### 3.3 配置修改监听

当用户修改关键配置时，自动清除验证状态：

```java
private void setupListeners() {
    // 提供商变更时清除验证状态
    providerComboBox.addActionListener(e -> {
        updateModelList();
        updateDefaultValues();
        updateApiKeyVisibility();
        markConfigurationAsUnverified();
    });
    
    // 监听其他关键配置变更
    baseUrlField.addActionListener(e -> markConfigurationAsUnverified());
    apiKeyField.addActionListener(e -> markConfigurationAsUnverified());
    modelComboBox.addActionListener(e -> markConfigurationAsUnverified());
}
```

**监听的配置项**：

- AI 提供商选择
- Base URL
- API Key
- 模型名称

#### 3.4 验证状态的保存和加载

```java
public SettingsState getSettings() {
    SettingsState settings = new SettingsState();
    // ... 其他配置
    settings.configurationVerified = this.configurationVerified;
    return settings;
}

public void loadSettings(@NotNull SettingsState settings) {
    // ... 其他配置
    this.configurationVerified = settings.configurationVerified;
}
```

### 4. TaskExecutor 友好的错误提示

**文件**: `src/main/java/com/github/intellijjavadocai/task/TaskExecutor.java`

当配置未验证时，显示友好的错误提示：

```java
public boolean processTasks(@NotNull List<DocumentationTask> tasks) {
    // 检查 AI 服务是否可用
    if (!isServiceAvailable()) {
        String errorMsg = JavaDocBundle.message("error.configuration.not.verified");
        log.info("AI 服务不可用: {}", errorMsg);
        indicator.setText("AI 服务配置错误");
        // 显示友好的通知提示
        NotificationUtil.notifyErrorMessage(project, errorMsg);
        return false;
    }
    // ... 处理任务
}
```

### 5. 国际化消息

#### 中文消息 (messages_zh_CN.properties)

```properties
error.configuration.not.verified=AI 提供商配置未通过验证。\n请在设置页面 (Settings → Tools → AI Javadoc) 点击"测试连接"并确保测试成功后再使用。
```

#### 英文消息 (messages.properties)

```properties
error.configuration.not.verified=AI provider configuration has not been verified.\nPlease go to Settings → Tools → AI Javadoc, click "Test Connection" and ensure it succeeds before using the plugin.
```

## 使用流程

### 首次配置

1. 用户打开设置页面：`Settings → Tools → AI Javadoc`
2. 选择 AI 提供商（如 qianwen 或 ollama）
3. 配置相关参数（Base URL、API Key、模型等）
4. **必须点击"测试连接"按钮**
5. 等待测试结果
6. 测试成功后，点击"OK"保存配置
7. 现在可以使用插件生成文档

### 修改配置

1. 打开设置页面修改配置
2. 修改关键配置（提供商、Base URL、API Key、模型）后，验证状态自动清除
3. **需要重新点击"测试连接"**
4. 测试成功后保存配置

### 使用插件

1. 如果配置未验证，插件会显示错误提示
2. 错误消息会引导用户去设置页面进行测试
3. 只有验证通过的配置才能正常使用

## 技术细节

### 验证状态的持久化

- 使用 IntelliJ Platform 的 `PersistentStateComponent` 机制
- 配置保存在 `JavaDocAI.xml` 文件中
- 重启 IDE 后验证状态保持

### 临时允许创建提供商

在以下场景需要临时绕过验证检查：

1. **测试连接时**：需要创建提供商实例进行验证
2. **获取模型列表时**：需要创建临时实例获取支持的模型
3. **获取默认值时**：需要创建临时实例获取默认配置
4. **获取显示名称时**：需要创建临时实例获取提供商名称

实现方式：

```java
SettingsState tempSettings = new SettingsState();
tempSettings.aiProvider = providerId;
// 临时允许创建未验证的提供商
tempSettings.configurationVerified = true;
AIServiceProvider provider = AIServiceFactory.createProvider(tempSettings);
```

### 线程安全

- UI 更新使用 `SwingUtilities.invokeLater()`
- 测试连接在后台线程执行
- 验证状态使用简单的 boolean 字段，访问在 EDT 线程

## 优点

1. **安全性**：确保只有有效的配置才能使用
2. **用户友好**：明确的错误提示和操作指引
3. **可扩展性**：为多提供商并行处理预留接口
4. **持久化**：验证状态在重启后保持
5. **自动管理**：配置修改时自动清除验证状态

## 未来扩展建议

### 多提供商配置

1. 扩展 `SettingsState` 支持多个提供商配置
2. 为每个提供商独立存储验证状态
3. UI 支持添加/删除/管理多个提供商

### 并行处理

使用 `getAvailableProviders()` 接口：

```java
List<AIServiceProvider> providers = AIServiceFactory.getAvailableProviders();

// 并行调用多个提供商
CompletableFuture<String>[] futures = providers.stream()
    .map(provider -> CompletableFuture.supplyAsync(() -> 
        provider.generateDocumentation(code, type, language)
    ))
    .toArray(CompletableFuture[]::new);

// 获取第一个成功的结果
String result = CompletableFuture.anyOf(futures)
    .get();
```

### 负载均衡

1. 实现轮询策略
2. 实现加权随机策略
3. 根据提供商响应时间动态调整

### 故障转移

1. 主提供商失败时自动切换到备用提供商
2. 记录失败次数，临时禁用故障提供商
3. 自动重试机制

## 相关文件

- `src/main/java/com/github/intellijjavadocai/settings/SettingsState.java`
- `src/main/java/com/github/intellijjavadocai/ai/AIServiceFactory.java`
- `src/main/java/com/github/intellijjavadocai/settings/ui/JavaDocSettingsPanel.java`
- `src/main/java/com/github/intellijjavadocai/task/TaskExecutor.java`
- `src/main/resources/messages_zh_CN.properties`
- `src/main/resources/messages.properties`

