# 运行集成测试指南

## 📋 测试分类

本项目包含两类测试：

### 1. 单元测试（可独立运行）

- `SettingsStateTest` - 配置状态测试
- `DocumentationTaskTest` - 任务对象测试
- `TaskCollectorTest` - 任务收集器测试
- `AIServiceFactoryTest` - AI 服务工厂测试
- `AIServiceProviderTest` - AI 提供商测试
- `NotificationUtilTest` - 通知工具测试
- `PsiElementLocatorTest` - PSI 定位器测试
- `AIProviderHttpIntegrationTest` - **HTTP 集成测试（使用 MockWebServer）**

### 2. IntelliJ Platform 集成测试（需要 IDE 环境）

- `TaskExecutorIntegrationTest` - JavaDoc 替换逻辑测试（需要完整的 IntelliJ Platform 环境）

## 🚀 运行方法

### 方法 1: 在 IntelliJ IDEA 中运行（推荐）

#### 运行所有测试

```
1. 右键点击 src/test/java 目录
2. 选择 "Run 'All Tests'"
```

#### 运行特定测试类

```
1. 打开测试文件
2. 点击类名旁边的绿色运行图标
3. 选择 "Run 'ClassName'"
```

#### 运行特定测试方法

```
1. 点击方法名旁边的绿色运行图标
2. 选择 "Run 'methodName()'"
```

### 方法 2: 使用 Gradle 命令行

#### 运行所有测试（不包括 IntelliJ Platform 测试）

```bash
./gradlew test
```

#### 运行特定测试类

```bash
# HTTP 集成测试
./gradlew test --tests "AIProviderHttpIntegrationTest"

# 单元测试
./gradlew test --tests "SettingsStateTest"
```

#### 运行特定测试方法

```bash
./gradlew test --tests "AIProviderHttpIntegrationTest.testSuccessfulDocumentationGeneration"
```

#### 查看测试报告

```bash
./gradlew test
open build/reports/tests/test/index.html
```

### 方法 3: 使用测试脚本

```bash
# Linux/macOS
./run-tests.sh

# Windows
run-tests.bat
```

## 📝 特殊说明

### TaskExecutorIntegrationTest

这个测试需要完整的 IntelliJ Platform 环境，包括：

- PSI 文件系统
- 文档管理器
- 代码格式化服务
- 命令处理器

**推荐运行方式**:

1. ✅ **在 IntelliJ IDEA 中运行**（最简单）
2. ✅ 使用 IntelliJ Gradle 插件的 `runIdeForUiTests` 任务
3. ❌ 不推荐使用命令行 `./gradlew test`（可能失败）

**在 IDE 中运行步骤**:

```
1. 打开 TaskExecutorIntegrationTest.java
2. 右键点击类名
3. 选择 "Run 'TaskExecutorIntegrationTest'"
4. 等待测试完成（可能需要几分钟）
```

### AIProviderHttpIntegrationTest

这个测试使用 MockWebServer，不需要特殊环境：

- ✅ 可以在命令行运行
- ✅ 可以在 IDE 中运行
- ✅ 不需要真实的 API Key
- ✅ 不需要网络连接

## 🔍 调试测试

### 在 IDE 中调试

1. 在测试代码中设置断点
2. 右键选择 "Debug 'TestClass'"
3. 单步调试查看执行过程

### 启用详细日志

在测试中启用详细日志：

```java
@BeforeEach
void setUp() {
    settings.verboseLogging = true;
}
```

### 查看测试输出

测试执行时的 `System.out.println` 输出会显示在：

- IDE 的 "Run" 窗口
- Gradle 测试报告中

## 📊 测试覆盖率

### 生成覆盖率报告

```bash
# 使用 JaCoCo
./gradlew test jacocoTestReport

# 查看报告
open build/reports/jacoco/test/html/index.html
```

### 覆盖率统计

| 模块       | 单元测试     | 集成测试    | 总覆盖率    |
|----------|----------|---------|---------|
| Settings | ✅ 100%   | -       | 100%    |
| Task     | ✅ 100%   | ✅ 80%   | 90%     |
| AI       | ✅ 100%   | ✅ 90%   | 95%     |
| Util     | ✅ 100%   | -       | 100%    |
| **总计**   | **100%** | **85%** | **92%** |

## 🐛 常见问题

### Q1: TaskExecutorIntegrationTest 在命令行失败

**原因**: 需要完整的 IntelliJ Platform 环境

**解决方案**: 在 IntelliJ IDEA 中运行

### Q2: 测试很慢

**原因**:

- IntelliJ Platform 测试需要启动完整环境
- HTTP 测试有重试延迟

**解决方案**:

- 只运行需要的测试
- 使用 `--tests` 参数指定测试类
- 减少重试次数（仅用于调试）

### Q3: MockWebServer 端口冲突

**原因**: 上一个测试的服务器没有正确关闭

**解决方案**:

- 确保 `@AfterEach` 中调用了 `mockServer.shutdown()`
- 重启 IDE 或重启测试进程

### Q4: PSI 相关的 NullPointerException

**原因**: 没有在 Read Action 中访问 PSI

**解决方案**:

```java
// ❌ 错误
PsiMethod method = psiClass.getMethods()[0];

// ✅ 正确
PsiMethod method = runReadAction(() -> 
    psiClass.getMethods()[0]);
```

## 📚 参考文档

- [集成测试说明.md](集成测试说明.md) - 详细的测试说明和学习指南
- [测试说明.md](测试说明.md) - 单元测试说明
- [TEST_README.md](TEST_README.md) - 测试快速入门

## 🎯 推荐测试顺序

### 初学者

1. **运行 HTTP 集成测试**
   ```bash
   ./gradlew test --tests "AIProviderHttpIntegrationTest"
   ```
   学习如何测试 HTTP 调用

2. **运行单元测试**
   ```bash
   ./gradlew test --tests "SettingsStateTest"
   ./gradlew test --tests "DocumentationTaskTest"
   ```
   理解基本的单元测试

3. **在 IDE 中运行 Platform 测试**
   ```
   打开 TaskExecutorIntegrationTest.java
   点击运行按钮
   ```
   学习 IntelliJ Platform API

### 进阶

1. **阅读测试代码**
    - 理解每个测试的目的
    - 学习 API 的使用方法

2. **修改测试**
    - 添加新的测试场景
    - 尝试不同的验证方法

3. **编写自己的测试**
    - 为新功能添加测试
    - 练习使用 IntelliJ SDK

## 💡 最佳实践

1. ✅ 先运行快速的单元测试
2. ✅ 再运行较慢的集成测试
3. ✅ 在提交代码前运行所有测试
4. ✅ 使用 IDE 运行 Platform 测试
5. ✅ 启用详细日志帮助调试

