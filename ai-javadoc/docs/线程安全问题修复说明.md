# çº¿ç¨‹å®‰å…¨é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯

```
java.lang.Throwable: Read access is allowed from inside read-action (or EDT) only 
(see com.intellij.openapi.application.Application.runReadAction())
	at com.intellij.psi.impl.source.PsiMethodImpl.getDocComment(PsiMethodImpl.java:257)
	at dev.dong4j.zeka.stack.idea.plugin.task.TaskExecutor.shouldSkip(TaskExecutor.java:148)
	at dev.dong4j.zeka.stack.idea.plugin.task.TaskExecutor.processTask(TaskExecutor.java:105)
```

### é—®é¢˜æ ¹æº

åœ¨ `TaskExecutor.shouldSkip()` æ–¹æ³•ä¸­ï¼Œä»£ç å°è¯•åœ¨åå°çº¿ç¨‹ä¸­ç›´æ¥è®¿é—® PSI å…ƒç´ ï¼š

```java
private boolean shouldSkip(@NotNull DocumentationTask task) {
    if (!settings.skipExisting) {
        return false;
    }

    PsiElement element = task.getElement();

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ–‡æ¡£
    if (element instanceof PsiDocCommentOwner) {
        PsiDocComment docComment = ((PsiDocCommentOwner) element).getDocComment();  // âŒ é”™è¯¯ï¼
        return docComment != null;
    }

    return false;
}
```

**é—®é¢˜**ï¼š

- âŒ `shouldSkip()` åœ¨åå°çº¿ç¨‹ï¼ˆ`Task.Backgroundable`ï¼‰ä¸­è¢«è°ƒç”¨
- âŒ `getDocComment()` è®¿é—® PSI æ ‘ç»“æ„
- âŒ PSI è®¿é—®å¿…é¡»åœ¨ read-action æˆ– EDT ä¸­æ‰§è¡Œ

---

## âœ… è§£å†³æ–¹æ¡ˆ

### IntelliJ Platform çº¿ç¨‹æ¨¡å‹

IntelliJ Platform ä½¿ç”¨ä¸¥æ ¼çš„çº¿ç¨‹æ¨¡å‹æ¥ä¿æŠ¤ PSIï¼ˆProgram Structure Interfaceï¼‰ï¼š

1. **Read-Action**ï¼šè¯»å– PSI æ•°æ®æ—¶å¿…é¡»åœ¨ read-action ä¸­
2. **Write-Action**ï¼šä¿®æ”¹ PSI æ•°æ®æ—¶å¿…é¡»åœ¨ write-action ä¸­ï¼ˆä¸”å¿…é¡»åœ¨ EDT ä¸­ï¼‰
3. **EDT (Event Dispatch Thread)**ï¼šUI æ“ä½œå’Œ write-action å¿…é¡»åœ¨ EDT ä¸­

### ä¿®å¤ä»£ç 

**æ–‡ä»¶**ï¼š`src/main/java/com/github/intellijjavadocai/task/TaskExecutor.java`

**ä¿®æ”¹å‰**ï¼š

```java
private boolean shouldSkip(@NotNull DocumentationTask task) {
    if (!settings.skipExisting) {
        return false;
    }

    PsiElement element = task.getElement();

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ–‡æ¡£
    if (element instanceof PsiDocCommentOwner) {
        PsiDocComment docComment = ((PsiDocCommentOwner) element).getDocComment();
        return docComment != null;
    }

    return false;
}
```

**ä¿®æ”¹å**ï¼š

```java
private boolean shouldSkip(@NotNull DocumentationTask task) {
    if (!settings.skipExisting) {
        return false;
    }

    // PSI è®¿é—®å¿…é¡»åœ¨ read-action ä¸­
    return ApplicationManager.getApplication().runReadAction((Computable<Boolean>) () -> {
        PsiElement element = task.getElement();

        // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ–‡æ¡£
        if (element instanceof PsiDocCommentOwner) {
            PsiDocComment docComment = ((PsiDocCommentOwner) element).getDocComment();
            return docComment != null;
        }

        return false;
    });
}
```

**å…³é”®å˜åŒ–**ï¼š

1. âœ… ä½¿ç”¨ `ApplicationManager.getApplication().runReadAction()` åŒ…è£… PSI è®¿é—®
2. âœ… ä½¿ç”¨ `Computable<Boolean>` è¿”å›ç»“æœ
3. âœ… æ·»åŠ äº†å¿…è¦çš„å¯¼å…¥ï¼š`import com.intellij.openapi.util.Computable;`

---

## ğŸ” ä¸ºä»€ä¹ˆéœ€è¦ Read-Action

### PSI çš„å¹¶å‘è®¿é—®æ§åˆ¶

IntelliJ Platform çš„ PSI ç³»ç»Ÿéœ€è¦å¤„ç†ä»¥ä¸‹å¹¶å‘åœºæ™¯ï¼š

1. **ç”¨æˆ·ç¼–è¾‘ä»£ç ** - åœ¨ EDT ä¸­ä¿®æ”¹ PSI
2. **åå°ç´¢å¼•** - åœ¨åå°çº¿ç¨‹ä¸­è¯»å– PSI
3. **ä»£ç åˆ†æ** - åœ¨åå°çº¿ç¨‹ä¸­è¯»å– PSI
4. **æ’ä»¶åŠŸèƒ½** - å¯èƒ½åœ¨ä»»ä½•çº¿ç¨‹ä¸­è®¿é—® PSI

ä¸ºäº†é˜²æ­¢å¹¶å‘è®¿é—®å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ï¼ŒIntelliJ Platform ä½¿ç”¨ **è¯»å†™é”æœºåˆ¶**ï¼š

- **Read-Lock**ï¼šå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å– PSI
- **Write-Lock**ï¼šç‹¬å è®¿é—®ï¼Œç”¨äºä¿®æ”¹ PSI

### ä¸ºä»€ä¹ˆ getDocComment() éœ€è¦ Read-Action

```java
// è¿™ä¸ªè°ƒç”¨é“¾éœ€è¦è®¿é—® PSI æ ‘ç»“æ„
element.getDocComment()
  â†’ PsiMethodImpl.getDocComment()
    â†’ PsiFileImpl.getStubTree()  // è®¿é—® PSI å†…éƒ¨æ•°æ®ç»“æ„
      â†’ assertReadAccessAllowed()  // æ£€æŸ¥æ˜¯å¦åœ¨ read-action ä¸­
        â†’ å¦‚æœä¸åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼ âŒ
```

---

## ğŸ“Š ä¿®å¤å¯¹æ¯”

### Beforeï¼ˆé”™è¯¯çš„æ–¹å¼ï¼‰

```
åå°çº¿ç¨‹ (Background Thread)
  â””â”€ processTask()
      â””â”€ shouldSkip()
          â””â”€ getDocComment()  âŒ ç›´æ¥è®¿é—® PSI
              â””â”€ æŠ›å‡ºå¼‚å¸¸: "Read access is allowed from inside read-action only"
```

### Afterï¼ˆæ­£ç¡®çš„æ–¹å¼ï¼‰

```
åå°çº¿ç¨‹ (Background Thread)
  â””â”€ processTask()
      â””â”€ shouldSkip()
          â””â”€ runReadAction()  âœ… è·å– read-lock
              â””â”€ getDocComment()  âœ… åœ¨ read-action ä¸­å®‰å…¨è®¿é—® PSI
```

---

## ğŸ¯ ç›¸å…³ä»£ç æ£€æŸ¥

### å…¶ä»– PSI è®¿é—®ç‚¹æ˜¯å¦å®‰å…¨ï¼Ÿ

è®©æˆ‘ä»¬æ£€æŸ¥ `TaskExecutor` ä¸­çš„å…¶ä»– PSI è®¿é—®ï¼š

#### 1. `getInsertPosition()` âœ… å®‰å…¨

```java
private int getInsertPosition(@NotNull PsiElement element) {
    if (element instanceof PsiMethod) {
        return ((PsiMethod) element).getModifierList().getTextRange().getStartOffset();
    }
    // ...
}
```

**ä¸ºä»€ä¹ˆå®‰å…¨**ï¼š

- åœ¨ `insertDocumentation()` æ–¹æ³•ä¸­è°ƒç”¨
- `insertDocumentation()` åœ¨ `invokeLater()` (EDT) ä¸­æ‰§è¡Œ
- EDT ä¸­å¯ä»¥å®‰å…¨è®¿é—® PSI

#### 2. `insertDocumentation()` âœ… å®‰å…¨

```java
private void insertDocumentation(...) {
    ApplicationManager.getApplication().invokeLater(() -> {  // â† åœ¨ EDT ä¸­
        // ...
        ApplicationManager.getApplication().runWriteAction(() -> {  // â† Write-action
            // ä¿®æ”¹ PSI
            document.insertString(...);
            // æ ¼å¼åŒ–ä»£ç 
            CodeStyleManager.getInstance(project).reformatText(...);
        });
    });
}
```

**ä¸ºä»€ä¹ˆå®‰å…¨**ï¼š

- åœ¨ EDT ä¸­æ‰§è¡Œ
- ä½¿ç”¨ `runWriteAction()` è¿›è¡Œä¿®æ”¹
- å®Œå…¨ç¬¦åˆ IntelliJ Platform çš„çº¿ç¨‹æ¨¡å‹

---

## ğŸ“š IntelliJ Platform çº¿ç¨‹å®‰å…¨æœ€ä½³å®è·µ

### 1. è¯»å– PSI æ•°æ®

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ runReadAction
ApplicationManager.getApplication().runReadAction(() -> {
    PsiElement element = ...;
    String text = element.getText();
    // è¯»å– PSI æ•°æ®
});

// âœ… æ­£ç¡®ï¼šè¿”å›å€¼
String result = ApplicationManager.getApplication().runReadAction((Computable<String>) () -> {
    return element.getText();
});
```

### 2. ä¿®æ”¹ PSI æ•°æ®

```java
// âœ… æ­£ç¡®ï¼šåœ¨ EDT ä¸­ä½¿ç”¨ runWriteAction
ApplicationManager.getApplication().invokeLater(() -> {
    ApplicationManager.getApplication().runWriteAction(() -> {
        // ä¿®æ”¹ PSI
        document.insertString(...);
    });
});
```

### 3. åå°ä»»åŠ¡ä¸­è®¿é—® PSI

```java
// âœ… æ­£ç¡®ï¼šTask.Backgroundable ä¸­è®¿é—® PSI
public class MyTask extends Task.Backgroundable {
    @Override
    public void run(@NotNull ProgressIndicator indicator) {
        // åå°çº¿ç¨‹
        
        // éœ€è¦è®¿é—® PSIï¼Ÿä½¿ç”¨ runReadAction
        ApplicationManager.getApplication().runReadAction(() -> {
            PsiElement element = ...;
            // è¯»å– PSI
        });
        
        // éœ€è¦ä¿®æ”¹ PSIï¼Ÿä½¿ç”¨ invokeLater + runWriteAction
        ApplicationManager.getApplication().invokeLater(() -> {
            ApplicationManager.getApplication().runWriteAction(() -> {
                // ä¿®æ”¹ PSI
            });
        });
    }
}
```

---

## âœ… éªŒè¯

### 1. ç¼–è¯‘æ£€æŸ¥

```bash
./gradlew compileJava
```

**ç»“æœ**ï¼šâœ… ç¼–è¯‘æˆåŠŸ

```
BUILD SUCCESSFUL in 10s
4 actionable tasks: 3 executed, 1 up-to-date
```

### 2. è¿è¡Œæµ‹è¯•

**æ“ä½œ**ï¼š

1. æ‰“å¼€ä¸€ä¸ª Java æ–‡ä»¶
2. åœ¨ç¼–è¾‘å™¨ä¸­å³é”®é€‰æ‹© "Generate JavaDoc with AI"
3. è§‚å¯Ÿæ˜¯å¦è¿˜æœ‰çº¿ç¨‹å®‰å…¨å¼‚å¸¸

**é¢„æœŸ**ï¼šâœ… ä¸å†å‡ºç° "Read access is allowed..." å¼‚å¸¸

---

## ğŸ“ æ€»ç»“

### é—®é¢˜

- âŒ åœ¨åå°çº¿ç¨‹ä¸­ç›´æ¥è®¿é—® PSI å…ƒç´ çš„ `getDocComment()` æ–¹æ³•
- âŒ è¿åäº† IntelliJ Platform çš„çº¿ç¨‹å®‰å…¨è§„åˆ™
- âŒ æŠ›å‡º "Read access is allowed from inside read-action only" å¼‚å¸¸

### è§£å†³æ–¹æ¡ˆ

- âœ… ä½¿ç”¨ `ApplicationManager.getApplication().runReadAction()` åŒ…è£… PSI è®¿é—®
- âœ… ç¡®ä¿æ‰€æœ‰ PSI è¯»å–æ“ä½œéƒ½åœ¨ read-action ä¸­æ‰§è¡Œ
- âœ… éµå¾ª IntelliJ Platform çš„çº¿ç¨‹æ¨¡å‹

### å½±å“

- âœ… ä¿®å¤äº†è¿è¡Œæ—¶å¼‚å¸¸
- âœ… æé«˜äº†æ’ä»¶çš„ç¨³å®šæ€§
- âœ… ç¬¦åˆ IntelliJ Platform çš„æœ€ä½³å®è·µ
- âœ… ç¡®ä¿çº¿ç¨‹å®‰å…¨

---

## ğŸ”— å‚è€ƒèµ„æ–™

1. **IntelliJ Platform SDK**
    - [Threading in IntelliJ Platform](https://plugins.jetbrains.com/docs/intellij/general-threading-rules.html)
    - [PSI and Read/Write Actions](https://plugins.jetbrains.com/docs/intellij/psi-files.html#accessing-psi)

2. **ç›¸å…³ API**
    - `ApplicationManager.getApplication().runReadAction()`
    - `ApplicationManager.getApplication().runWriteAction()`
    - `ApplicationManager.getApplication().invokeLater()`
    - `Computable<T>` - ç”¨äºä» read-action è¿”å›å€¼
